<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文章阅读 - SMSF 英语学习</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- 修正zt字体文件路径 -->
    <link rel="stylesheet" href="../zt/fonts.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        body {
            background: #1A202C;
            color: #E2E8F0;
            min-height: 100vh;
        }

        /* 顶部导航栏 - 继承student-learning样式 */
        nav {
            background: #2D3748;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #4A5568;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }

        .logo-text {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #38B2AC 0%, #4FD1C7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'Chiron Hei HK', sans-serif;
        }

        .logo-subtitle {
            font-size: 0.85rem;
            color: #A0AEC0;
            font-family: 'Hedvig Letters Sans', sans-serif;
            margin-top: 3px;
        }

        .nav-buttons {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-btn {
            background: #4A5568;
            color: #A0AEC0;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: #38B2AC;
            color: #1A202C;
        }

        /* 主容器 - 左右分栏布局 */
        .reading-container {
            display: flex;
            height: calc(100vh - 80px);
            min-height: 700px;
        }

        /* 左侧边栏 */
        .left-sidebar {
            width: 300px;
            background: #2D3748;
            border-right: 1px solid #4A5568;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .article-stats {
            background: #1A202C;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #4A5568;
        }

        .stat-item {
            margin-bottom: 15px;
        }

        .stat-label {
            font-size: 14px;
            color: #A0AEC0;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #38B2AC;
        }

        .difficulty-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            color: #1A202C;
        }

        .difficulty-beginner {
            background: #48BB78;
        }

        .difficulty-intermediate {
            background: #38B2AC;
        }

        .difficulty-advanced {
            background: #4299E1;
        }

        /* 生词本区域 */
        .new-words-section {
            flex: 1;
            background: #1A202C;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #4A5568;
            display: flex;
            flex-direction: column;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #E2E8F0;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .new-words-list {
            flex: 1;
            overflow-y: auto;
        }

        .word-item {
            background: #2D3748;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #4A5568;
            transition: all 0.3s ease;
        }

        .word-item:hover {
            border-color: #38B2AC;
            transform: translateX(5px);
        }

        .word-original {
            font-size: 16px;
            font-weight: 600;
            color: #38B2AC;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .word-translation {
            font-size: 14px;
            color: #A0AEC0;
        }

        /* 移除生词按钮样式 */
        .remove-word-btn {
            background: #E53E3E;
            color: #FFFFFF;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .remove-word-btn:hover {
            background: #C53030;
            transform: scale(1.1);
        }

        .empty-words {
            text-align: center;
            color: #A0AEC0;
            padding: 30px 0;
        }

        .empty-words i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #4A5568;
        }

        /* 右侧主要内容区 - 重新设计为块级元素滚动 */
        .main-content {
            flex: 1;
            display: block; /* 改为block显示以便整体滚动 */
            overflow-y: auto;
            height: 100%;
        }

        /* 文章头部容器 - 作为滚动内容的一部分 */
        .article-header-container {
            /* 这个容器包含头部和过渡区域 */
        }

        /* 文章头部 - 使用mask-image实现向下渐变透明过渡 */
        .article-header {
            /* 背景图片将在JavaScript中动态设置 */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            
            /* 渐变遮罩 - 从不透明到透明（向下渐变）*/
            mask-image: linear-gradient(to bottom, 
                black 0%,            /* 顶部完全不透明 */
                rgba(0,0,0,0.95) 10%, /* 10%位置 95%不透明 */
                rgba(0,0,0,0.9) 15%,  /* 15%位置 90%不透明 */
                rgba(0,0,0,0.85) 20%, /* 20%位置 85%不透明 */
                rgba(0,0,0,0.8) 30%,  /* 30%位置 80%不透明 */
                rgba(0,0,0,0.75) 35%, /* 35%位置 75%不透明 */
                rgba(0,0,0,0.7) 45%,  /* 45%位置 70%不透明 */
                rgba(0,0,0,0.65) 50%, /* 50%位置 65%不透明 */
                rgba(0,0,0,0.6) 60%,  /* 60%位置 60%不透明 */
                rgba(0,0,0,0.5) 65%,  /* 65%位置 50%不透明 */
                rgba(0,0,0,0.4) 75%,  /* 75%位置 40%不透明 */
                rgba(0,0,0,0.3) 80%,  /* 80%位置 30%不透明 */
                rgba(0,0,0,0.2) 90%,  /* 90%位置 20%不透明 */
                rgba(0,0,0,0.1) 95%,  /* 95%位置 10%不透明 */
                transparent 100%);    /* 底部完全透明 */
            
            /* 兼容WebKit浏览器 */
            -webkit-mask-image: -webkit-linear-gradient(top, 
                black 0%,
                rgba(0,0,0,0.95) 10%,
                rgba(0,0,0,0.9) 15%,
                rgba(0,0,0,0.85) 20%,
                rgba(0,0,0,0.8) 30%,
                rgba(0,0,0,0.75) 35%,
                rgba(0,0,0,0.7) 45%,
                rgba(0,0,0,0.65) 50%,
                rgba(0,0,0,0.6) 60%,
                rgba(0,0,0,0.5) 65%,
                rgba(0,0,0,0.4) 75%,
                rgba(0,0,0,0.3) 80%,
                rgba(0,0,0,0.2) 90%,
                rgba(0,0,0,0.1) 95%,
                transparent 100%);
            
            padding: 20px 30px;
            border-bottom: 1px solid #4A5568;
            transition: all 0.5s ease-in-out;
            position: relative;
            min-height: 250px; /* 增加容器高度 */
            display: flex;
            align-items: center;
        }

        .article-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(56, 178, 172, 0.1) 0%, 
                rgba(79, 209, 199, 0.05) 50%, 
                rgba(56, 178, 172, 0.1) 100%);
            transition: opacity 0.5s ease-in-out;
            opacity: 0;
        }

        .article-header:hover::before {
            opacity: 1;
        }

        /* 过渡衔接区域 - 延续mask效果 */
        .header-transition {
            height: 60px;
            background: #1A202C; /* 深色背景 */
            
            /* 继续渐变遮罩效果 */
            mask-image: linear-gradient(to bottom, 
                black 0%,           /* 顶部完全不透明 */
                rgba(0,0,0,0.8) 20%, /* 80%不透明 */
                rgba(0,0,0,0.6) 40%, /* 60%不透明 */
                rgba(0,0,0,0.4) 60%, /* 40%不透明 */
                rgba(0,0,0,0.2) 80%, /* 20%不透明 */
                transparent 100%);   /* 底部完全透明 */
            
            /* 兼容WebKit浏览器 */
            -webkit-mask-image: -webkit-linear-gradient(top, 
                black 0%,
                rgba(0,0,0,0.8) 20%,
                rgba(0,0,0,0.6) 40%,
                rgba(0,0,0,0.4) 60%,
                rgba(0,0,0,0.2) 80%,
                transparent 100%);
            
            margin-top: -1px;
            position: relative;
            z-index: 1;
        }

        .header-content {
            position: relative;
            z-index: 2;
            width: 100%;
        }

        .article-title {
            font-size: 28px;
            font-weight: bold;
            color: #E2E8F0;
            margin-bottom: 10px;
            font-family: 'Academica Book', 'Noto Sans SC', sans-serif;
            font-style: italic;
            font-weight: bold;
        }

        .article-topic {
            font-size: 16px;
            color: #A0AEC0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .article-content {
            padding: 30px;
            line-height: 1.8;
            font-size: 18px;
            background: transparent; /* 确保内容区域背景透明 */
        }

        .article-text {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            color: #E2E8F0;
        }

        .article-text p {
            margin-bottom: 20px;
            text-align: justify;
        }

        /* 可点击的单词样式 */
        .clickable-word {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .clickable-word:hover {
            background: rgba(56, 178, 172, 0.3);
            color: #38B2AC;
        }

        .clickable-word.selected {
            background: rgba(56, 178, 172, 0.5);
            color: #FFFFFF;
            font-weight: 600;
        }

        /* 词汇释义弹窗 */
        .word-popup {
            position: fixed;
            background: #2D3748;
            border: 1px solid #38B2AC;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            min-width: 300px;
            max-width: 400px;
            display: none;
        }

        .word-popup.show {
            display: block;
            animation: popupFadeIn 0.3s ease;
        }

        @keyframes popupFadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #4A5568;
        }

        .popup-word {
            font-size: 20px;
            font-weight: 700;
            color: #38B2AC;
        }

        .popup-close {
            background: none;
            border: none;
            color: #A0AEC0;
            cursor: pointer;
            font-size: 18px;
            transition: color 0.3s ease;
        }

        .popup-close:hover {
            color: #E2E8F0;
        }

        .popup-phonetic {
            font-size: 14px;
            color: #718096;
            margin-bottom: 10px;
            font-style: italic;
        }

        .popup-definition {
            font-size: 16px;
            color: #E2E8F0;
            line-height: 1.6;
        }

        .popup-levels {
            font-size: 14px;
            color: #38B2AC;
            margin: 8px 0;
            padding: 6px 12px;
            background: rgba(56, 178, 172, 0.1);
            border-radius: 6px;
            border-left: 3px solid #38B2AC;
        }

        .popup-example {
            margin-top: 15px;
            padding: 12px;
            background: #1A202C;
            border-radius: 8px;
            border-left: 3px solid #38B2AC;
        }

        .popup-example-title {
            font-size: 14px;
            color: #38B2AC;
            margin-bottom: 8px;
        }

        .popup-example-text {
            font-size: 14px;
            color: #A0AEC0;
            font-style: italic;
        }

        /* 添加生词按钮样式 */
        .add-to-vocabulary {
            background: #38B2AC;
            color: #1A202C;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
            transition: all 0.3s ease;
            display: block;
            width: 100%;
        }

        .add-to-vocabulary:hover {
            background: #4FD1C7;
            transform: translateY(-2px);
        }

        .add-to-vocabulary:disabled {
            background: #4A5568;
            color: #A0AEC0;
            cursor: not-allowed;
            transform: none;
        }

        /* 底部控制栏 */
        .bottom-controls {
            background: #2D3748;
            padding: 15px 30px;
            border-top: 1px solid #4A5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reading-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-text {
            font-size: 14px;
            color: #A0AEC0;
        }

        .progress-bar {
            width: 200px;
            height: 8px;
            background: #4A5568;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #38B2AC;
            transition: width 0.3s ease;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            background: #4A5568;
            color: #A0AEC0;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .control-btn:hover {
            background: #38B2AC;
            color: #1A202C;
        }

        /* 段落翻译弹窗 */
        .translation-popup {
            position: fixed;
            background: #2D3748;
            border: 1px solid #38B2AC;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            min-width: 300px;
            max-width: 500px;
            display: none;
        }

        .translation-popup.show {
            display: block;
            animation: popupFadeIn 0.3s ease;
        }

        .translation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #4A5568;
        }

        .translation-title {
            font-size: 18px;
            font-weight: 600;
            color: #38B2AC;
        }

        .translation-close {
            background: none;
            border: none;
            color: #A0AEC0;
            cursor: pointer;
            font-size: 18px;
            transition: color 0.3s ease;
        }

        .translation-close:hover {
            color: #E2E8F0;
        }

        .translation-content {
            font-size: 16px;
            color: #E2E8F0;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .translation-loading {
            color: #A0AEC0;
            font-style: italic;
        }

        /* 响应式设计 */
        @media (max-width: 1024px) {
            .left-sidebar {
                width: 250px;
            }

            .article-content {
                padding: 20px;
                font-size: 16px;
            }
        }

        @media (max-width: 768px) {
            .reading-container {
                flex-direction: column;
                height: auto;
            }

            .left-sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #4A5568;
            }

            .article-stats {
                display: flex;
                gap: 20px;
                margin-bottom: 15px;
            }

            .stat-item {
                margin-bottom: 0;
            }

            .article-header {
                padding: 15px 20px;
            }

            .article-title {
                font-size: 24px;
            }

            .bottom-controls {
                flex-direction: column;
                gap: 10px;
                padding: 15px 20px;
            }

            .reading-progress {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav>
        <div class="logo-section">
            <img src="resource_web/logo_64.png" alt="SMSF Logo" class="logo-icon">
            <div>
                <div class="logo-text">SMSF 英语阅读</div>
                <div class="logo-subtitle">Passage Reading</div>
            </div>
        </div>

        <div class="nav-buttons">
            <button class="nav-btn" onclick="goBack()">
                <i class="fas fa-arrow-left"></i>
                返回文库
            </button>
            <button class="nav-btn" onclick="toggleWordList()">
                <i class="fas fa-book"></i>
                生词本
            </button>
        </div>
    </nav>

    <!-- 阅读主容器 -->
    <div class="reading-container">
        <!-- 左侧边栏 -->
        <aside class="left-sidebar">
            <!-- 文章统计信息 -->
            <div class="article-stats">
                <div class="stat-item">
                    <div class="stat-label">词数统计</div>
                    <div class="stat-value" id="wordCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">阅读难度</div>
                    <div class="difficulty-badge difficulty-intermediate" id="difficultyBadge">中级</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">阅读时间</div>
                    <div class="stat-value" id="readingTime">0分钟</div>
                </div>
            </div>

            <!-- 生词本区域 -->
            <div class="new-words-section">
                <div class="section-title">
                    <i class="fas fa-book"></i>
                    生词本
                </div>
                <div class="new-words-list" id="newWordsList">
                    <div class="empty-words">
                        <i class="fas fa-book-open"></i>
                        <p>点击文章中的单词添加到生词本</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 右侧主要内容区 -->
        <main class="main-content">
            <!-- 头部容器（会随滚动移动） -->
            <div class="article-header-container">
                <!-- 文章头部 -->
                <header class="article-header">
                    <div class="header-content">
                        <h1 class="article-title" id="articleTitle">文章标题加载中...</h1>
                        <div class="article-topic">
                            <i class="fas fa-tag"></i>
                            <span id="articleTopic">主题加载中...</span>
                        </div>
                    </div>
                </header>
                
                <!-- 头部与正文之间的过渡衔接 -->
                <div class="header-transition"></div>
            </div>

            <!-- 文章内容 -->
            <div class="article-content">
                <div class="article-text" id="articleContent">
                    <p>文章内容加载中...</p>
                </div>
            </div>

            <!-- 底部控制栏 -->
            <div class="bottom-controls">
                <div class="reading-progress">
                    <span class="progress-text">阅读进度:</span>
                    <div class="progress-bar">
                        <div class="progress-fill" id="readingProgress" style="width: 0%"></div>
                    </div>
                    <span class="progress-text" id="progressPercent">0%</span>
                </div>

                <div class="control-buttons">
                    <button class="control-btn" onclick="decreaseFontSize()">
                        <i class="fas fa-text-height"></i>
                        缩小
                    </button>
                    <button class="control-btn" onclick="increaseFontSize()">
                        <i class="fas fa-text-height"></i>
                        放大
                    </button>
                    <button class="control-btn" onclick="toggleDarkMode()">
                        <i class="fas fa-moon"></i>
                        夜间模式
                    </button>
                    <button class="control-btn" onclick="completeReading()" style="background: #38B2AC; color: #1A202C;">
                        <i class="fas fa-check-circle"></i>
                        完成阅读
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- 词汇释义弹窗 -->
    <div class="word-popup" id="wordPopup">
        <div class="popup-header">
            <div class="popup-word" id="popupWord">单词</div>
            <button class="popup-close" onclick="closeWordPopup()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="popup-phonetic" id="popupPhonetic">/dɑːk/</div>
        <div class="popup-definition" id="popupDefinition">黑暗的；深色的</div>
        <div class="popup-levels" id="popupLevels">等级: 高中, 雅思</div>
        <div class="popup-example">
            <div class="popup-example-title">例句:</div>
            <div class="popup-example-text" id="popupExample">The room was dark and quiet.</div>
        </div>
        <button class="add-to-vocabulary" id="addToVocabularyBtn" onclick="addCurrentWordToVocabulary()">
            <i class="fas fa-plus"></i> 加入生词本
        </button>
    </div>

    <!-- 段落翻译弹窗 -->
    <div class="translation-popup" id="translationPopup">
        <div class="translation-header">
            <div class="translation-title">
                <i class="fas fa-language"></i> 段落翻译
            </div>
            <button class="translation-close" onclick="closeTranslationPopup()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="translation-content" id="translationContent">
            翻译内容将在这里显示...
        </div>
    </div>

    <script>
        // 全局变量
        let currentArticle = null;
        let newWords = []; // 存储生词对象数组 [{word: '单词', id: 123}, ...]
        let newWordIds = []; // 存储生词的单词ID数组
        let fontSize = 18;
        let isDarkMode = false;
        let readingStartTime = Date.now();
        let currentSelectedWord = null; // 新增：记录当前选中的单词

        // 全局变量用于防抖
        let translationTimeout = null;
        let lastSelectedText = '';

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 从URL参数获取文章ID
            const urlParams = new URLSearchParams(window.location.search);
            const articleId = urlParams.get('id');

            if (articleId) {
                loadArticle(articleId);
            } else {
                // 如果没有文章ID，显示示例内容
                loadSampleArticle();
            }

            // 设置滚动监听
            setupScrollListener();

            // 设置点击事件监听
            setupClickListeners();
        });

        // 加载文章
        async function loadArticle(articleId) {
            try {
                console.log('开始加载文章，ID:', articleId);
                // 修正API路径，使用正确的endpoint
                const response = await fetch(`/api/english-passage/${articleId}`);
                const result = await response.json();
                console.log('API响应结果:', result);

                if (result.success) {
                    currentArticle = result.article;
                    console.log('接收到的文章数据:', currentArticle);
                    console.log('封面图片URL:', currentArticle.cover_picture_url);
                    displayArticle(currentArticle);
                } else {
                    console.error('加载文章失败:', result.message);
                    loadSampleArticle();
                }
            } catch (error) {
                console.error('加载文章时出错:', error);
                loadSampleArticle();
            }
        }

        // 加载示例文章
        function loadSampleArticle() {
            currentArticle = {
                id: 1,
                title: "The Shape of Time",
                topic: "Science & Technology",
                content: "Time is one of the most fundamental concepts in physics and philosophy. Scientists have long debated the nature of time and whether it flows like a river or exists as a static dimension. Einstein's theory of relativity revolutionized our understanding by showing that time is relative to the observer's frame of reference. This means that time can dilate or contract depending on speed and gravitational fields. Modern physics suggests that time might be an emergent property rather than a fundamental aspect of reality. The arrow of time, pointing from past to future, remains one of the greatest mysteries in science.",
                difficulty: "intermediate",
                wordCount: 127,
                cover_picture_url: "../zt/academica_book_bold_italic-s.p.1f42b458.woff2" // 示例图片路径
            };
            displayArticle(currentArticle);
        }

        // 显示文章内容
        function displayArticle(article) {
            // 设置文章标题
            document.getElementById('articleTitle').textContent = article.title;

            // 设置文章主题
            document.getElementById('articleTopic').textContent = article.topic;

            // 设置难度等级
            const difficultyBadge = document.getElementById('difficultyBadge');
            difficultyBadge.className = `difficulty-badge difficulty-${article.difficulty}`;
            difficultyBadge.textContent = getDifficultyText(article.difficulty);

            // 设置词数统计
            document.getElementById('wordCount').textContent = article.wordCount || countWords(article.content);

            // 设置封面背景图片
            const articleHeader = document.querySelector('.article-header');
            console.log('文章封面URL:', article.cover_picture_url);
            
            if (article.cover_picture_url) {
                // 使用CSS自定义属性设置背景图片
                articleHeader.style.setProperty('--cover-image', `url('${article.cover_picture_url}')`);
                console.log('设置封面背景:', article.cover_picture_url);
                // 也直接设置background-image作为备用
                articleHeader.style.backgroundImage = `url('${article.cover_picture_url}')`;
            } else {
                // 如果没有封面图片，使用默认背景
                articleHeader.style.setProperty('--cover-image', 'none');
                articleHeader.style.backgroundImage = 'none';
                console.log('使用默认背景');
            }

            // 处理并显示文章内容
            const contentElement = document.getElementById('articleContent');
            contentElement.innerHTML = processArticleContent(article.content);

            // 调试信息：显示段落翻译数据
            console.log('文章段落翻译数据:', article.paragraph_translations);
            if (article.paragraph_translations && article.paragraph_translations.length > 0) {
                console.log('✅ 段落翻译数据加载成功');
                console.log('段落数量:', article.paragraph_translations.length);
                // 显示前几个段落的翻译预览
                article.paragraph_translations.slice(0, 3).forEach((para, index) => {
                    console.log(`段落${index}:`, para.original.substring(0, 50) + '...', '->', para.translation.substring(0, 50) + '...');
                });
            } else {
                console.log('⚠️ 未找到段落翻译数据');
            }

            // 开始计时
            readingStartTime = Date.now();
            updateReadingTime();
            
            // 初始化进度条
            setTimeout(updateReadingProgress, 100);
        }

        // 处理文章内容，添加可点击单词和段落索引
        function processArticleContent(content) {
            // 将内容按双换行符分割成段落
            const paragraphs = content.split('\n\n').filter(p => p.trim());

            return paragraphs.map((paragraph, index) => {
                // 将段落中的单词包装成可点击元素，并添加段落索引
                const processedParagraph = paragraph.replace(/\b([a-zA-Z]+)\b/g, '<span class="clickable-word" data-word="$1">$1</span>');
                return `<p data-paragraph-index="${index}" class="article-paragraph">${processedParagraph}</p>`;
            }).join('');
        }

        // 统计词数
        function countWords(text) {
            return text.split(/\s+/).filter(word => word.length > 0).length;
        }

        // 获取难度文本
        function getDifficultyText(difficulty) {
            const map = {
                'beginner': '初级',
                'intermediate': '中级',
                'advanced': '高级'
            };
            return map[difficulty] || '未知';
        }

        // 设置滚动监听
        function setupScrollListener() {
            // 首先尝试绑定到 .main-content（主要滚动容器）
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.addEventListener('scroll', updateReadingProgress);
                console.log('✅ 滚动监听已设置在 .main-content 元素上');
                return;
            }
            
            // 如果找不到 .main-content，尝试绑定到 .article-content
            const articleContent = document.querySelector('.article-content');
            if (articleContent) {
                articleContent.addEventListener('scroll', updateReadingProgress);
                console.log('✅ 滚动监听已设置在 .article-content 元素上');
                return;
            }
            
            console.error('❌ 未找到任何可滚动的容器元素');
        }

        // 更新阅读进度
        function updateReadingProgress() {
            // 优先检查 .main-content（主要滚动容器）
            let scrollElement = document.querySelector('.main-content');
            
            // 如果 .main-content 不存在或不可滚动，检查 .article-content
            if (!scrollElement || scrollElement.scrollHeight <= scrollElement.clientHeight) {
                scrollElement = document.querySelector('.article-content');
            }
            
            if (!scrollElement) {
                console.error('❌ 未找到任何可滚动的元素');
                return;
            }
            
            const scrollTop = scrollElement.scrollTop;
            const scrollHeight = scrollElement.scrollHeight - scrollElement.clientHeight;
            
            // 防止除零错误
            if (scrollHeight <= 0) {
                console.warn('⚠️ 滚动高度为0，可能内容不足');
                document.getElementById('readingProgress').style.width = '0%';
                document.getElementById('progressPercent').textContent = '0%';
                return;
            }
            
            const progress = Math.round((scrollTop / scrollHeight) * 100);
            
            // 调试信息
            console.log(`滚动进度: ${scrollTop}/${scrollHeight} = ${progress}% (来自 ${scrollElement.className || scrollElement.id})`);

            document.getElementById('readingProgress').style.width = `${progress}%`;
            document.getElementById('progressPercent').textContent = `${progress}%`;
        }

        // 设置点击事件监听
        function setupClickListeners() {
            document.addEventListener('click', function(e) {
                // 点击可点击单词
                if (e.target.classList.contains('clickable-word')) {
                    const word = e.target.dataset.word.toLowerCase();
                    showWordDefinition(word, e);
                }

                // 点击其他地方关闭弹窗
                if (!e.target.closest('.word-popup') && !e.target.classList.contains('clickable-word')) {
                    closeWordPopup();
                }
                
                // 点击其他地方关闭翻译弹窗
                if (!e.target.closest('.translation-popup')) {
                    closeTranslationPopup();
                }
            });
            
            // 使用防抖的selectionchange事件监听
            let selectionTimer = null;
            document.addEventListener('selectionchange', function() {
                // 清除之前的定时器
                if (selectionTimer) {
                    clearTimeout(selectionTimer);
                }
                
                // 延迟执行避免频闪
                selectionTimer = setTimeout(function() {
                    handleTextSelection();
                }, 300); // 300ms防抖延迟
            });
        }

        // 处理文本选择 - 带防抖和去重，使用段落索引获取精准翻译
        function handleTextSelection() {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            // 避免重复处理相同内容
            if (selectedText === lastSelectedText && selectedText.length > 0) {
                return;
            }
            
            lastSelectedText = selectedText;
            
            if (selectedText.length > 0) {
                // 直接获取选中范围的父元素
                const range = selection.getRangeAt(0);
                const commonAncestor = range.commonAncestorContainer;
                
                // 查找包含选中内容的段落
                let paragraph = commonAncestor;
                if (paragraph.nodeType === Node.TEXT_NODE) {
                    paragraph = paragraph.parentElement;
                }
                
                // 向上查找直到找到p标签
                while (paragraph && paragraph.tagName !== 'P') {
                    paragraph = paragraph.parentElement;
                }
                
                // 确保是段落元素且在文章区域内
                const articleContent = document.querySelector('.article-content');
                if (paragraph && articleContent && articleContent.contains(paragraph)) {
                    const fullText = paragraph.textContent.trim();
                    const paragraphIndex = parseInt(paragraph.getAttribute('data-paragraph-index'));
                    
                    // 扩展选择到整个段落
                    const newRange = document.createRange();
                    newRange.selectNodeContents(paragraph);
                    selection.removeAllRanges();
                    selection.addRange(newRange);
                    
                    // 显示翻译（带防抖）
                    if (translationTimeout) {
                        clearTimeout(translationTimeout);
                    }
                    
                    translationTimeout = setTimeout(() => {
                        const rect = paragraph.getBoundingClientRect();
                        showTranslationPopupByIndex(paragraphIndex, fullText, rect);
                    }, 100);
                }
            } else {
                // 延迟关闭避免误关闭
                setTimeout(() => {
                    if (window.getSelection().toString().trim() === '') {
                        closeTranslationPopup();
                    }
                }, 200);
            }
        }

        // 显示翻译弹窗（通过段落索引获取精准翻译）
        function showTranslationPopupByIndex(paragraphIndex, originalText, rect) {
            const popup = document.getElementById('translationPopup');
            const translationContent = document.getElementById('translationContent');
            
            // 显示加载状态
            translationContent.innerHTML = '<div class="translation-loading">正在获取段落翻译...</div>';
            popup.classList.add('show');
            
            // 定位弹窗在段落下方居中
            const scrollTop = document.querySelector('.article-content').scrollTop;
            const articleRect = document.querySelector('.article-content').getBoundingClientRect();
            
            popup.style.left = `${articleRect.left + articleRect.width/2 - 250}px`; // 居中显示
            popup.style.top = `${rect.bottom + 20 + scrollTop}px`;
            
            // 从数据库获取精准翻译
            getTranslationByParagraphIndex(paragraphIndex, originalText).then(translation => {
                translationContent.textContent = translation;
            }).catch(error => {
                translationContent.innerHTML = '<div class="translation-loading">翻译获取失败: ' + error.message + '</div>';
            });
        }

        // 通过段落索引从数据库获取翻译（新增函数）
        async function getTranslationByParagraphIndex(paragraphIndex, originalText) {
            if (!currentArticle || !currentArticle.id) {
                throw new Error('当前文章信息不完整');
            }
            
            try {
                const response = await fetch(`/api/english-passage/${currentArticle.id}/paragraph-translation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        paragraph_index: paragraphIndex,
                        selected_text: originalText
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    return result.translation.translation;
                } else {
                    throw new Error(result.message || '获取翻译失败');
                }
            } catch (error) {
                console.error('获取段落翻译失败:', error);
                throw error;
            }
        }

        // 显示翻译弹窗（旧版函数，保留向后兼容）
        function showTranslationPopup(text, rect) {
            const popup = document.getElementById('translationPopup');
            const translationContent = document.getElementById('translationContent');
            
            // 显示加载状态
            translationContent.innerHTML = '<div class="translation-loading">正在翻译整个段落...</div>';
            popup.classList.add('show');
            
            // 定位弹窗在段落下方居中
            const scrollTop = document.querySelector('.article-content').scrollTop;
            const articleRect = document.querySelector('.article-content').getBoundingClientRect();
            
            popup.style.left = `${articleRect.left + articleRect.width/2 - 250}px`; // 居中显示
            popup.style.top = `${rect.bottom + 20 + scrollTop}px`;
            
            // 获取翻译（模拟）
            getTranslation(text).then(translation => {
                translationContent.textContent = translation;
            }).catch(error => {
                translationContent.innerHTML = '<div class="translation-loading">翻译获取失败</div>';
            });
        }

        // 关闭翻译弹窗
        function closeTranslationPopup() {
            document.getElementById('translationPopup').classList.remove('show');
        }

        // 获取翻译（模拟函数，实际应调用翻译API）
        async function getTranslation(text) {
            // 模拟翻译延迟
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 更完整的段落翻译示例
            const translations = {
                'Time is one of the most fundamental concepts in physics and philosophy. Scientists have long debated the nature of time and whether it flows like a river or exists as a static dimension.': '时间是物理学和哲学中最基本的概念之一。科学家们长期以来一直在争论时间的本质，以及它是像河流一样流动还是作为静态维度存在。',
                'Einstein\'s theory of relativity revolutionized our understanding by showing that time is relative to the observer\'s frame of reference. This means that time can dilate or contract depending on speed and gravitational fields.': '爱因斯坦的相对论通过表明时间相对于观察者的参考系而言是相对的，从而彻底改变了我们的理解。这意味着时间可以根据速度和引力场而膨胀或收缩。',
                'Modern physics suggests that time might be an emergent property rather than a fundamental aspect of reality. The arrow of time, pointing from past to future, remains one of the greatest mysteries in science.': '现代物理学表明，时间可能是涌现属性，而不是现实的基本方面。时间之箭，从过去指向未来，仍然是科学中最大的谜团之一。'
            };
            
            // 查找匹配的翻译或返回默认翻译
            return translations[text] || `段落翻译: ${text.substring(0, 100)}...`;
        }

        // 显示单词定义
        async function showWordDefinition(word, event) {
            // 记录当前选中的单词
            currentSelectedWord = word;

            const popup = document.getElementById('wordPopup');
            const popupWord = document.getElementById('popupWord');
            const popupPhonetic = document.getElementById('popupPhonetic');
            const popupDefinition = document.getElementById('popupDefinition');
            const popupExample = document.getElementById('popupExample');
            const popupLevels = document.getElementById('popupLevels');
            const addToVocabBtn = document.getElementById('addToVocabularyBtn');

            // 显示加载状态
            popupWord.textContent = word;
            popupPhonetic.textContent = '加载中...';
            popupDefinition.textContent = '正在查询单词定义...';
            popupExample.textContent = '';
            if (popupLevels) popupLevels.textContent = '';

            // 定位弹窗
            const rect = event.target.getBoundingClientRect();
            const scrollTop = document.querySelector('.article-content').scrollTop;
            popup.style.left = `${rect.left}px`;
            popup.style.top = `${rect.bottom + 10 + scrollTop}px`;
            popup.classList.add('show');

            try {
                // 调用后端API获取单词定义
                const response = await fetch(`/api/vocabulary/${encodeURIComponent(word)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.word) {
                    const wordData = result.word;
                    
                    // 更新弹窗内容
                    popupWord.textContent = wordData.word || word;
                    
                    // 音标显示（支持新旧字段名）
                    const phonetic = wordData.phonetic || wordData.pho_symbol || '无音标数据';
                    popupPhonetic.textContent = phonetic;
                    
                    // 定义显示（支持新旧字段名）
                    const definition = wordData.translation || wordData['Chinese Definition'] || '暂无中文释义';
                    popupDefinition.textContent = definition;
                    
                    // 显示等级信息（如果存在）
                    if (popupLevels && wordData.levels) {
                        popupLevels.textContent = `等级: ${wordData.levels}`;
                    } else if (popupLevels && wordData.tag) {
                        // 如果没有转换后的levels，直接显示原始tag
                        popupLevels.textContent = `标签: ${wordData.tag}`;
                    }
                    
                    // 词频信息暂时不显示
                    // if (wordData.frq) {
                    //     const frqInfo = document.createElement('div');
                    //     frqInfo.className = 'popup-frequency';
                    //     frqInfo.textContent = `词频: ${wordData.frq}`;
                    //     // 插入到定义后面
                    //     popupDefinition.parentNode.insertBefore(frqInfo, popupDefinition.nextSibling);
                    // }
                    
                    // 示例句子暂时不显示
                    // popupExample.textContent = '暂无例句';
                    // 隐藏例句框
                    popupExample.style.display = 'none';
                } else {
                    // API返回无结果
                    popupPhonetic.textContent = '无音标数据';
                    popupDefinition.textContent = '词汇库中暂无此词的定义';
                    // popupExample.textContent = '暂无例句';
                    popupExample.style.display = 'none';
                    if (popupLevels) popupLevels.textContent = '';
                }
            } catch (error) {
                console.error('获取单词定义失败:', error);
                // 显示错误信息
                popupPhonetic.textContent = '无音标数据';
                popupDefinition.textContent = `查询失败: ${error.message}`;
                // popupExample.textContent = '请稍后重试';
                popupExample.style.display = 'none';
                if (popupLevels) popupLevels.textContent = '';
            }

            // 更新按钮状态
            if (newWords.some(item => item.word === word)) {
                addToVocabBtn.disabled = true;
                addToVocabBtn.innerHTML = '<i class="fas fa-check"></i> 已添加';
            } else {
                addToVocabBtn.disabled = false;
                addToVocabBtn.innerHTML = '<i class="fas fa-plus"></i> 加入生词本';
            }
        }

        // 获取单词定义（模拟数据）
        function getWordDefinition(word) {
            const dictionary = {
                'time': {
                    word: 'time',
                    phonetic: '/taɪm/',
                    definition: '时间；时代；次数',
                    example: 'Time flies when you\'re having fun.'
                },
                'science': {
                    word: 'science',
                    phonetic: '/ˈsaɪəns/',
                    definition: '科学；学科',
                    example: 'Modern science has made many discoveries.'
                },
                'physics': {
                    word: 'physics',
                    phonetic: '/ˈfɪzɪks/',
                    definition: '物理学',
                    example: 'Physics studies the fundamental laws of nature.'
                },
                'relativity': {
                    word: 'relativity',
                    phonetic: '/ˌreləˈtɪvəti/',
                    definition: '相对论；相对性',
                    example: 'Einstein\'s theory of relativity changed physics.'
                },
                'dimension': {
                    word: 'dimension',
                    phonetic: '/daɪˈmenʃn/',
                    definition: '维度；方面',
                    example: 'Space has three dimensions.'
                }
            };

            return dictionary[word] || {
                word: word,
                phonetic: '/word/',
                definition: '词汇库中暂无此词的定义',
                example: '暂无例句'
            };
        }

        // 关闭单词弹窗
        function closeWordPopup() {
            document.getElementById('wordPopup').classList.remove('show');
        }

        // 添加当前单词到生词本
        async function addCurrentWordToVocabulary() {
            if (currentSelectedWord && !newWords.some(item => item.word === currentSelectedWord)) {
                // 获取单词ID
                const wordId = await getWordId(currentSelectedWord);
                if (wordId) {
                    // 正确地将对象推入数组
                    const newWordIndex = newWords.length; // 记录新单词的索引
                    newWords.push({
                        word: currentSelectedWord,
                        id: wordId
                    });
                    newWordIds.push(wordId); // 保存单词ID
                    
                    // 只更新新添加的单词，而不是整个列表
                    await updateNewWordsList(newWordIndex);

                    // 更新按钮状态
                    const addToVocabBtn = document.getElementById('addToVocabularyBtn');
                    addToVocabBtn.disabled = true;
                    addToVocabBtn.innerHTML = '<i class="fas fa-check"></i> 已添加';

                    // 更新单词样式
                    document.querySelectorAll(`.clickable-word[data-word="${currentSelectedWord}"]`).forEach(element => {
                        element.classList.add('selected');
                    });
                } else {
                    alert('获取单词信息失败，请稍后重试');
                }
            }
        }

        // 添加到生词本（移除自动添加功能）
        function addToNewWords(word) {
            // 不再自动添加，只在点击按钮时添加
            // 此函数保留用于可能的其他用途
        }

        // 更新生词本列表
        async function updateNewWordsList(newWordIndex = null) {
            const listElement = document.getElementById('newWordsList');

            if (newWords.length === 0) {
                listElement.innerHTML = `
                    <div class="empty-words">
                        <i class="fas fa-book-open"></i>
                        <p>点击文章中的单词添加到生词本</p>
                    </div>
                `;
                return;
            }

            // 如果是首次加载或重新渲染全部
            if (newWordIndex === null) {
                // 显示加载状态
                listElement.innerHTML = newWords.map((wordObj, index) => {
                    return `
                        <div class="word-item" data-word-index="${index}">
                            <div class="word-original">
                                ${wordObj.word}
                                <button class="remove-word-btn" onclick="removeWordFromVocabulary(${index})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="word-translation">加载中...</div>
                        </div>
                    `;
                }).join('');

                // 异步获取所有单词的定义
                for (let i = 0; i < newWords.length; i++) {
                    await loadWordDefinition(i);
                }
            } else {
                // 只添加新单词，不重新渲染整个列表
                const wordObj = newWords[newWordIndex];
                const newWordElement = document.createElement('div');
                newWordElement.className = 'word-item';
                newWordElement.dataset.wordIndex = newWordIndex;
                newWordElement.innerHTML = `
                    <div class="word-original">
                        ${wordObj.word}
                        <button class="remove-word-btn" onclick="removeWordFromVocabulary(${newWordIndex})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="word-translation">加载中...</div>
                `;
                
                // 添加到列表末尾
                listElement.appendChild(newWordElement);
                
                // 只加载这个新单词的定义
                await loadWordDefinition(newWordIndex);
            }
        }

        // 单独加载单词定义的函数
        async function loadWordDefinition(wordIndex) {
            const wordObj = newWords[wordIndex];
            const word = wordObj.word;
            
            // 查找对应的DOM元素
            const wordElement = document.querySelector(`.word-item[data-word-index="${wordIndex}"]`);
            if (!wordElement) return;
            
            const translationElement = wordElement.querySelector('.word-translation');
            if (!translationElement) return;
            
            try {
                const response = await fetch(`/api/vocabulary/${encodeURIComponent(word)}`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.word) {
                        const wordData = result.word;
                        // 支持新旧字段名
                        const definition = wordData.translation || wordData['Chinese Definition'] || '暂无中文释义';
                        translationElement.textContent = definition;
                    } else {
                        translationElement.textContent = '暂无定义';
                    }
                } else {
                    translationElement.textContent = '查询失败';
                }
            } catch (error) {
                console.error(`获取单词 ${word} 定义失败:`, error);
                translationElement.textContent = '加载失败';
            }
        }

        // 移除生词功能
        function removeWordFromVocabulary(index) {
            if (index >= 0 && index < newWords.length) {
                const removedWordObj = newWords[index];
                const removedWord = removedWordObj.word;
                
                // 从数组中移除
                newWords.splice(index, 1);
                newWordIds.splice(index, 1); // 同时移除对应的ID
                
                // 从DOM中移除对应的元素
                const wordElement = document.querySelector(`.word-item[data-word-index="${index}"]`);
                if (wordElement) {
                    wordElement.remove();
                }
                
                // 更新后续元素的索引属性
                const remainingElements = document.querySelectorAll('.word-item');
                remainingElements.forEach((element, newIndex) => {
                    element.dataset.wordIndex = newIndex;
                    // 更新删除按钮的onclick属性
                    const removeBtn = element.querySelector('.remove-word-btn');
                    if (removeBtn) {
                        removeBtn.onclick = () => removeWordFromVocabulary(newIndex);
                    }
                });
                
                // 如果生词本为空，显示空状态
                if (newWords.length === 0) {
                    const listElement = document.getElementById('newWordsList');
                    listElement.innerHTML = `
                        <div class="empty-words">
                            <i class="fas fa-book-open"></i>
                            <p>点击文章中的单词添加到生词本</p>
                        </div>
                    `;
                }
                
                // 移除选中样式
                document.querySelectorAll(`.clickable-word[data-word="${removedWord}"]`).forEach(element => {
                    element.classList.remove('selected');
                });
            }
        }

        // 更新阅读时间
        function updateReadingTime() {
            const elapsedMinutes = Math.floor((Date.now() - readingStartTime) / 60000);
            document.getElementById('readingTime').textContent = `${elapsedMinutes}分钟`;

            // 每分钟更新一次
            setTimeout(updateReadingTime, 60000);
        }

        // 字体大小控制
        function increaseFontSize() {
            fontSize = Math.min(fontSize + 2, 24);
            document.querySelector('.article-text').style.fontSize = `${fontSize}px`;
        }

        function decreaseFontSize() {
            fontSize = Math.max(fontSize - 2, 14);
            document.querySelector('.article-text').style.fontSize = `${fontSize}px`;
        }

        // 夜间模式切换
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.style.backgroundColor = isDarkMode ? '#0F172A' : '#1A202C';
            document.querySelector('.article-text').style.color = isDarkMode ? '#F1F5F9' : '#E2E8F0';
        }

        // 返回文库
        function goBack() {
            window.location.href = '/static/OKComputer_企业化网页重设/student_learning.html#english-zone';
        }

        // 切换生词本显示
        function toggleWordList() {
            const sidebar = document.querySelector('.left-sidebar');
            sidebar.style.display = sidebar.style.display === 'none' ? 'block' : 'none';
        }

        // 完成阅读功能
        async function completeReading() {
            try {
                // 计算阅读时间和进度
                const readingDuration = Math.floor((Date.now() - readingStartTime) / 1000); // 秒
                const readingMinutes = Math.floor(readingDuration / 60); // 分钟
                const progressPercent = document.getElementById('progressPercent').textContent;
                
                // 显示确认对话框
                const confirmResult = confirm(`确定要完成阅读吗？

阅读时长: ${readingMinutes}分钟${readingDuration%60}秒
阅读进度: ${progressPercent}
生词数量: ${newWords.length}个`);
                
                if (!confirmResult) {
                    return;
                }
                
                // 获取当前登录用户账户（从多种途径获取）
                console.log('🔄 开始获取当前用户账户...');
                const currentUserAccount = await getCurrentUserAccount();
                console.log('🎯 获取到的用户账户:', currentUserAccount);
                
                if (!currentUserAccount) {
                    console.error('❌ 未检测到登录用户');
                    alert('⚠️ 未检测到登录用户，请先登录后再完成阅读');
                    return;
                }
                console.log('✅ 用户账户获取成功:', currentUserAccount);
                
                // 准备提交的数据
                const readingData = {
                    article_id: currentArticle?.id || 1,
                    title: currentArticle?.title || '示例文章',
                    duration: readingDuration,
                    progress: parseInt(progressPercent) || 0,
                    new_words_count: newWords.length,
                    new_words: newWords.map(item => item.word), // 保持原有格式向后兼容
                    new_words_with_id: newWords, // 新增：包含ID的生词数据
                    completed_at: new Date().toISOString()
                };
                
                console.log('提交阅读完成数据:', readingData);
                
                // 保存生词到数据库
                if (newWords.length > 0) {
                    try {
                        console.log('🔄 开始保存生词到数据库...');
                        const saveWordsResponse = await saveNewWordsToDatabase(currentUserAccount, currentArticle?.id || 1, newWords);
                        if (saveWordsResponse.success) {
                            console.log('✅ 生词保存成功');
                        } else {
                            console.warn('⚠️ 生词保存失败:', saveWordsResponse.message);
                        }
                    } catch (error) {
                        console.error('❌ 保存生词时出错:', error);
                    }
                }
                
                // 保存生词ID到数据库
                if (newWordIds.length > 0) {
                    console.log('💾 开始保存生词ID到数据库...');
                    console.log('生词IDs:', newWordIds);
                    const saveResponse = await saveNewWordIds(currentUserAccount, newWordIds);
                    if (saveResponse.success) {
                        console.log('✅ 生词ID保存成功');
                    } else {
                        console.error('❌ 生词ID保存失败:', saveResponse.message);
                    }
                }
                
                // 调用经验值更新API
                const expResponse = await updateReadingExp(currentUserAccount, readingMinutes, newWords.length);
                
                if (expResponse.success) {
                    // 显示完成提示，包含经验值信息
                    alert(`🎉 阅读完成！

文章: ${readingData.title}
时长: ${readingMinutes}分钟${readingDuration%60}秒
进度: ${progressPercent}
收获: ${newWords.length}个新单词

✨ 获得经验值: ${expResponse.exp_gained}点
   - 阅读时间奖励: ${readingMinutes * 30}点 (${readingMinutes}分钟 × 30)
   - 生词学习奖励: ${newWords.length * 5}点 (${newWords.length}个生词 × 5)`);
                    
                    // 经验值更新成功后重定向到学习页面
                    console.log('✅ 经验值更新成功，准备重定向到学习页面');
                    setTimeout(() => {
                        window.location.href = '/static/OKComputer_企业化网页重设/student_learning.html';
                    }, 1000); // 延迟1秒后跳转，让用户看到提示信息
                } else {
                    // 经验值更新失败但仍显示阅读完成
                    alert(`🎉 阅读完成！

文章: ${readingData.title}
时长: ${readingMinutes}分钟${readingDuration%60}秒
进度: ${progressPercent}
收获: ${newWords.length}个新单词

⚠️ 经验值更新失败: ${expResponse.message}`);
                    
                    // 即使经验值更新失败也重定向到学习页面
                    console.log('⚠️ 经验值更新失败，但仍重定向到学习页面');
                    setTimeout(() => {
                        window.location.href = '/static/OKComputer_企业化网页重设/student_learning.html';
                    }, 1000);
                }
                
            } catch (error) {
                console.error('完成阅读时出错:', error);
                alert('完成阅读时出现错误，请稍后再试');
            }
        }
        
        // 获取当前登录用户账户
        async function getCurrentUserAccount() {
            try {
                console.log('🔍 开始获取当前用户账户...');
                
                // 方法1: 检查Cookie中的session_id
                const sessionId = getCookie('session_id');
                if (sessionId) {
                    console.log('找到session_id:', sessionId);
                    // 通过API验证会话有效性并获取用户信息
                    const userInfo = await getUserInfoFromSession();
                    console.log('getUserInfoFromSession返回:', userInfo);
                    if (userInfo && userInfo.account) {
                        console.log('✅ 通过会话获取用户账户成功:', userInfo.account);
                        return userInfo.account;
                    }
                }
                
                // 方法2: 从localStorage获取用户信息
                const currentUser = localStorage.getItem('currentUser');
                if (currentUser) {
                    try {
                        const userData = JSON.parse(currentUser);
                        const account = userData.account || userData.user_account;
                        if (account) {
                            return account;
                        }
                    } catch (e) {
                        console.warn('解析localStorage用户数据失败:', e);
                    }
                }
                
                // 方法3: 检查专门的用户账户存储
                const savedAccount = localStorage.getItem('current_user_account');
                if (savedAccount) {
                    return savedAccount;
                }
                
                // 方法4: 从传统Cookie获取
                const userAccountCookie = getCookie('user_account');
                if (userAccountCookie) {
                    return decodeURIComponent(userAccountCookie);
                }
                
                // 方法5: 从URL参数获取（如果适用）
                const urlParams = new URLSearchParams(window.location.search);
                const accountParam = urlParams.get('account');
                if (accountParam) {
                    return accountParam;
                }
                
                // 方法6: 调用后端API获取当前用户信息
                const userInfo = await getCurrentUserInfo();
                if (userInfo && userInfo.account) {
                    return userInfo.account;
                }
                
                console.warn('⚠️ 未找到有效的用户账户信息');
                return null;
                
            } catch (error) {
                console.error('获取用户账户时出错:', error);
                return null;
            }
        }
        
        // 获取Cookie值
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
        
        // 通过会话获取用户信息
        async function getUserInfoFromSession() {
            try {
                const response = await fetch('/api/current_user', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.user) {
                        console.log('通过会话获取用户信息成功:', data.user);
                        // 确保返回正确的账户信息格式
                        if (data.user.account) {
                            return { account: data.user.account };
                        }
                        return data.user;
                    }
                }
                return null;
            } catch (error) {
                console.error('通过会话获取用户信息失败:', error);
                return null;
            }
        }
        
        // 获取当前用户信息
        async function getCurrentUserInfo() {
            try {
                const response = await fetch('/api/check-user-type', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.userType) {
                        console.log('获取当前用户信息成功:', data);
                        // 根据用户类型返回对应的账户信息
                        if ((data.userType === 'free' || data.userType === 'student') && data.user && data.user.account) {
                            return { account: data.user.account };
                        } else if (data.userType === 'teacher' && data.teacherAccount) {
                            return { account: data.teacherAccount };
                        }
                    }
                }
                return null;
            } catch (error) {
                console.error('获取当前用户信息失败:', error);
                return null;
            }
        }
        
        // 保存生词到数据库的API调用
        async function saveNewWordsToDatabase(account, articleId, wordsWithId) {
            try {
                const response = await fetch('/api/save-new-words', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        account: account,
                        article_id: articleId,
                        words: wordsWithId // 格式: [{word: '单词', id: 123}, ...]
                    })
                });
                
                const result = await response.json();
                return result;
                
            } catch (error) {
                console.error('保存生词到数据库失败:', error);
                return {
                    success: false,
                    message: '网络错误: ' + error.message
                };
            }
        }
        
        // 获取单词ID的函数
        async function getWordId(word) {
            try {
                const response = await fetch(`/api/vocabulary/${encodeURIComponent(word)}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                if (result.success && result.word && result.word.id) {
                    return result.word.id;
                } else {
                    console.warn(`未找到单词 '${word}' 的ID`);
                    return null;
                }
            } catch (error) {
                console.error(`获取单词 '${word}' ID失败:`, error);
                return null;
            }
        }
        
        // 保存生词ID到数据库的API调用
        async function saveNewWordIds(account, wordIds) {
            try {
                const response = await fetch('/api/save-new-word-ids', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        account: account,
                        word_ids: wordIds
                    })
                });
                
                const result = await response.json();
                return result;
                
            } catch (error) {
                console.error('保存生词ID API调用失败:', error);
                return {
                    success: false,
                    message: '网络错误，请稍后重试'
                };
            }
        }
        
        // 更新阅读经验值的API调用
        async function updateReadingExp(account, readingMinutes, unknownWordsCount) {
            try {
                const response = await fetch('/api/update-reading-exp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        account: account,
                        reading_minutes: readingMinutes,
                        unknown_words_count: unknownWordsCount
                    })
                });
                
                const result = await response.json();
                return result;
                
            } catch (error) {
                console.error('更新经验值API调用失败:', error);
                return {
                    success: false,
                    message: '网络错误，请稍后重试'
                };
            }
        }

        // 点击外部关闭弹窗
        document.addEventListener('click', function(e) {
            const popup = document.getElementById('wordPopup');
            if (!popup.contains(e.target) && !e.target.classList.contains('clickable-word')) {
                closeWordPopup();
            }
        });
    </script>
</body>
</html>
