<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学习资源 - SMSF 在线学习平台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- 引入工具函数 -->
    <script src="/static/OKComputer_企业化网页重设/utils.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans SC', 'Quattrocento Sans', sans-serif;
        }

        body {
            background: #1A202C;
            color: #E2E8F0;
            min-height: 100vh;
        }

        /* 顶部导航栏 */
        nav {
            background: #2D3748;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #4A5568;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }

        .logo-text {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #38B2AC 0%, #4FD1C7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'Chiron Hei HK', sans-serif;
        }

        .logo-subtitle {
            font-size: 0.85rem;
            color: #A0AEC0;
            font-family: 'Hedvig Letters Sans', sans-serif;
            margin-top: 3px;
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .nav-link {
            color: #A0AEC0;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-link:hover {
            background: #4A5568;
            color: #38B2AC;
        }

        .nav-link.active {
            background: #38B2AC;
            color: #1A202C;
        }

        .back-button {
            background: #4A5568;
            color: #E2E8F0;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-button:hover {
            background: #38B2AC;
            color: #1A202C;
        }

        /* 主要内容区域 */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .page-header {
            margin-bottom: 3rem;
            text-align: center;
        }

        .page-title {
            font-size: 2.8rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #38B2AC 0%, #4FD1C7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'Chiron Hei HK', sans-serif;
            font-weight: 700;
        }

        .page-subtitle {
            font-size: 1.2rem;
            color: #A0AEC0;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.7;
        }

        /* 资源分类导航 */
        .categories-nav {
            background: #2D3748;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 3rem;
            border: 1px solid #4A5568;
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }
        
        .category-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: stretch;
        }
        
        /* 确保所有分类按钮高度一致 */
        .category-btn {
            background: #4A5568;
            color: #A0AEC0;
            border: none;
            padding: 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 80px; /* 确保最小高度一致 */
            box-sizing: border-box;
        }

        .category-btn {
            background: #4A5568;
            color: #A0AEC0;
            border: none;
            padding: 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            position: relative;
        }

        .category-btn:hover {
            background: #38B2AC;
            color: #1A202C;
            transform: translateY(-3px);
        }

        .category-btn.active {
            background: #38B2AC;
            color: #1A202C;
        }

        .category-icon {
            font-size: 1.5rem;
        }

        /* 学科下拉菜单 */
        .subject-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #2D3748;
            border: 1px solid #4A5568;
            border-radius: 8px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .subject-dropdown.show {
            display: block;
        }

        .subject-item {
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #A0AEC0;
        }

        .subject-item:hover {
            background: #38B2AC;
            color: #1A202C;
        }

        .subject-item.active {
            background: rgba(56, 178, 172, 0.3);
            color: #38B2AC;
        }

        /* 资源展示区域 */
        .resources-section {
            margin-bottom: 3rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #4A5568;
        }

        .section-title {
            font-size: 1.8rem;
            color: #E2E8F0;
            font-family: 'Chiron Hei HK', sans-serif;
            font-weight: 600;
        }

        .section-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .search-box {
            background: #2D3748;
            border: 1px solid #4A5568;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            color: #E2E8F0;
            width: 250px;
        }

        .search-box:focus {
            outline: none;
            border-color: #38B2AC;
            box-shadow: 0 0 0 2px rgba(56, 178, 172, 0.2);
        }

        .sort-select {
            background: #2D3748;
            border: 1px solid #4A5568;
            border-radius: 8px;
            padding: 0.5rem;
            color: #E2E8F0;
        }

        /* 资源网格 */
        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
        }

        .resource-card {
            background: #2D3748;
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            border: 1px solid #4A5568;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .resource-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            border-color: #38B2AC;
        }

        .resource-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .resource-icon {
            width: 50px;
            height: 50px;
            background: #38B2AC;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #1A202C;
        }

        .resource-type {
            background: rgba(56, 178, 172, 0.2);
            color: #38B2AC;
            padding: 0.2rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .resource-title {
            font-size: 1.3rem;
            color: #E2E8F0;
            margin-bottom: 0.8rem;
            font-weight: 600;
            font-family: 'Chiron Hei HK', sans-serif;
        }

        .resource-description {
            color: #A0AEC0;
            line-height: 1.6;
            margin-bottom: 1.2rem;
            font-size: 0.95rem;
        }

        .resource-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #718096;
        }

        .resource-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .tag {
            background: rgba(74, 85, 104, 0.5);
            color: #A0AEC0;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .resource-actions {
            display: flex;
            gap: 0.8rem;
        }

        .action-btn {
            flex: 1;
            padding: 0.6rem;
            border-radius: 8px;
            text-decoration: none;
            text-align: center;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .primary-btn {
            background: #38B2AC;
            color: #1A202C;
        }

        .primary-btn:hover {
            background: #4FD1C7;
            transform: translateY(-2px);
        }

        .secondary-btn {
            background: transparent;
            color: #38B2AC;
            border: 1px solid #38B2AC;
        }

        .secondary-btn:hover {
            background: #38B2AC;
            color: #1A202C;
        }

        /* 推荐资源区域 */
        .recommended-section {
            background: linear-gradient(135deg, #2D3748 0%, #4A5568 100%);
            border-radius: 16px;
            padding: 2.5rem;
            margin: 3rem 0;
            border: 1px solid #4A5568;
        }

        .recommended-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .recommended-title {
            font-size: 2rem;
            color: #E2E8F0;
            margin-bottom: 0.5rem;
            font-family: 'Chiron Hei HK', sans-serif;
            font-weight: 600;
        }

        .recommended-subtitle {
            color: #A0AEC0;
            font-size: 1.1rem;
        }

        .recommended-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .recommended-card {
            background: #1A202C;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #4A5568;
            transition: all 0.3s ease;
        }

        .recommended-card:hover {
            border-color: #38B2AC;
            transform: translateY(-3px);
        }

        .recommended-badge {
            display: inline-block;
            background: #38B2AC;
            color: #1A202C;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        /* 分页控件 */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 3rem;
        }

        .page-btn {
            background: #4A5568;
            color: #A0AEC0;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .page-btn:hover {
            background: #38B2AC;
            color: #1A202C;
        }

        .page-btn.active {
            background: #38B2AC;
            color: #1A202C;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            .page-title {
                font-size: 2.2rem;
            }
            
            nav {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.8rem;
            }
            
            .categories-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .resources-grid {
                grid-template-columns: 1fr;
            }
            
            .section-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .section-controls {
                width: 100%;
                flex-direction: column;
            }
            
            .search-box {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .categories-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .resource-actions {
                flex-direction: column;
            }
        }

        /* 通知动画 */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav>
        <div class="logo-section">
            <img src="resource_web/logo_64.png" alt="SMSF Logo" class="logo-icon">
            <div>
                <div class="logo-text">SMSF 学习资源</div>
                <div class="logo-subtitle">Learning Resources Center</div>
            </div>
        </div>
        
        <div class="nav-links">
            <a href="/learning-platform" class="nav-link">
                <i class="fas fa-home"></i>
                首页
            </a>
            <a href="#" class="nav-link active">
                <i class="fas fa-book"></i>
                学习资源
            </a>
            <a href="/index" class="nav-link">
                <i class="fas fa-cogs"></i>
                智慧管理
            </a>
            <a href="/downloads" class="nav-link">
                <i class="fas fa-download"></i>
                下载中心
            </a>
        </div>
        
        <button class="back-button" onclick="window.location.href='register_login.html'">
            <i class="fas fa-sign-in-alt"></i>
            登录
        </button>
    </nav>

    <!-- 主要内容区域 -->
    <div class="container">
        <!-- 页面头部 -->
        <div class="page-header">
            <h1 class="page-title">学习资源中心</h1>
            <p class="page-subtitle">汇聚优质教育资源，为您提供全面、系统的学习材料和工具，助力您的学习之旅更加高效和充实</p>
        </div>

        <!-- 资源分类导航 -->
        <div class="categories-nav">
            <div class="categories-grid">
                <button class="category-btn active" data-category="all">
                    <i class="fas fa-th-large category-icon"></i>
                    <span>全部资源</span>
                </button>
                <div class="category-container">
                    <button class="category-btn" data-category="video" id="videoCategoryBtn">
                        <i class="fas fa-video category-icon"></i>
                        <span>视频资源</span>
                    </button>
                    <!-- 视频学科下拉菜单 -->
                    <div class="subject-dropdown" id="videoSubjectDropdown">
                        <div class="subject-item active" data-subject-id="all">全部学科</div>
                    </div>
                </div>
                <div class="category-container">
                    <button class="category-btn" data-category="exercise" id="exerciseCategoryBtn">
                        <i class="fas fa-tasks category-icon"></i>
                        <span>习题资源</span>
                    </button>
                    <!-- 习题学科下拉菜单 -->
                    <div class="subject-dropdown" id="exerciseSubjectDropdown">
                        <div class="subject-item active" data-subject-id="all">全部学科</div>
                    </div>
                </div>
                <button class="category-btn" data-category="other">
                    <i class="fas fa-folder category-icon"></i>
                    <span>其他资源</span>
                </button>
            </div>
        </div>

        <!-- 推荐资源区域 -->
        <div class="recommended-section">
            <div class="recommended-header">
                <h2 class="recommended-title">精选推荐</h2>
                <p class="recommended-subtitle">根据您的学习历史和兴趣，为您精心挑选的优质资源</p>
            </div>
            <div class="recommended-grid">
                <!-- 推荐资源将通过JavaScript动态生成 -->
            </div>
        </div>

        <!-- 资源展示区域 -->
        <div class="resources-section">
            <div class="section-header">
                <h2 class="section-title">全部学习资源</h2>
                <div class="section-controls">
                    <input type="text" class="search-box" placeholder="搜索资源..." id="searchInput">
                    <select class="sort-select" id="sortSelect">
                        <option value="latest">最新发布</option>
                        <option value="popular">最受欢迎</option>
                        <option value="rating">评分最高</option>
                    </select>
                </div>
            </div>

            <div class="resources-grid" id="resourcesGrid">
                <!-- 资源卡片将通过JavaScript动态生成 -->
            </div>

            <!-- 分页控件 -->
            <div class="pagination" id="pagination">
                <!-- 分页按钮将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>

    <script>
        // 资源数据
        let resourcesData = [];
        let subjectsData = [];
        let selectedVideoSubject = 'all';
        let selectedExerciseSubject = 'all';

        // 当前显示的资源
        let currentResources = [];
        let currentPage = 1;
        const itemsPerPage = 6;

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            loadResources();
            setupEventListeners();
            setupCategoryHover();
        });

        // 从API加载资源数据
        async function loadResources() {
            try {
                // 使用工具函数构建API URL
                const apiUrl = buildApiUrl('/api/study-resources');
                console.log('资源API请求URL:', apiUrl);
                
                const response = await fetch(apiUrl);
                const result = await response.json();
                
                if (result.success) {
                    resourcesData = result.resources;
                    currentResources = [...resourcesData];
                    renderRecommendedResources(); // 渲染推荐资源
                    renderResources(); // 渲染全部资源
                } else {
                    console.error('获取资源失败:', result.message);
                    showErrorMessage('加载资源失败，请稍后重试');
                }
            } catch (error) {
                console.error('加载资源时出错:', error);
                showErrorMessage('网络错误，请检查网络连接');
            }
        }

        // 从API加载学科数据
        async function loadSubjects() {
            console.log('开始加载学科数据...');
            
            try {
                // 使用工具函数构建API URL
                const apiUrl = buildApiUrl('/api/subjects');
                console.log('学科API请求URL:', apiUrl);
                
                const response = await fetch(apiUrl);
                console.log('学科API响应状态:', response.status);
                
                const result = await response.json();
                console.log('学科API响应数据:', result);
                
                if (result.success) {
                    subjectsData = result.subjects || [];
                    console.log(`成功获取 ${subjectsData.length} 个学科`);
                    
                    if (subjectsData.length > 0) {
                        console.log('学科列表:', subjectsData);
                    }
                    
                    renderSubjectDropdown();
                } else {
                    console.error('获取学科失败:', result.message);
                    subjectsData = [];
                }
            } catch (error) {
                console.error('加载学科时出错:', error);
                subjectsData = [];
            }
        }

        // 渲染推荐资源
        function renderRecommendedResources() {
            if (!resourcesData || resourcesData.length === 0) return;
            
            const recommendedGrid = document.querySelector('.recommended-grid');
            if (!recommendedGrid) return;
            
            // 从所有资源中随机选择3个
            const shuffled = [...resourcesData].sort(() => 0.5 - Math.random());
            const selectedResources = shuffled.slice(0, 3);
            
            // 定义推荐标签
            const badges = ['热门推荐', '最新发布', '编辑推荐'];
            
            const recommendedHTML = selectedResources.map((resource, index) => `
                <div class="recommended-card">
                    <span class="recommended-badge">${badges[index] || '推荐资源'}</span>
                    <h3 class="resource-title">${resource.title}</h3>
                    <p class="resource-description">${resource.description}</p>
                    <div class="resource-meta">
                        <span><i class="fas fa-download"></i> ${resource.downloads.toLocaleString()}次下载</span>
                        <span><i class="fas fa-star"></i> ${resource.rating}分</span>
                    </div>
                </div>
            `).join('');
            
            recommendedGrid.innerHTML = recommendedHTML;
        }
        
        // 显示错误消息
        function showErrorMessage(message) {
            const grid = document.getElementById('resourcesGrid');
            grid.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #EF4444;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <p style="font-size: 1.2rem;">${message}</p>
                    <button class="action-btn primary-btn" onclick="loadResources()" style="margin-top: 1rem;">
                        <i class="fas fa-redo"></i> 重新加载
                    </button>
                </div>
            `;
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 分类筛选
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 隐藏所有学科下拉菜单
                    hideAllSubjectDropdowns();
                    
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const category = this.dataset.category;
                    filterByCategory(category);
                });
            });

            // 搜索功能
            document.getElementById('searchInput').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filterBySearch(searchTerm);
            });

            // 排序功能
            document.getElementById('sortSelect').addEventListener('change', function() {
                sortBy(this.value);
            });

            // 学科筛选
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('subject-item')) {
                    const subjectId = e.target.dataset.subjectId;
                    const parentDropdown = e.target.closest('.subject-dropdown');
                    
                    // 确定是哪个分类的学科筛选
                    let isVideoFilter = parentDropdown.id === 'videoSubjectDropdown';
                    let isExerciseFilter = parentDropdown.id === 'exerciseSubjectDropdown';
                    
                    if (isVideoFilter) {
                        selectedVideoSubject = subjectId;
                    } else if (isExerciseFilter) {
                        selectedExerciseSubject = subjectId;
                    }
                    
                    // 更新选中状态
                    parentDropdown.querySelectorAll('.subject-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    // 应用学科筛选
                    if (isVideoFilter) {
                        filterByVideoSubject(subjectId);
                    } else if (isExerciseFilter) {
                        filterByExerciseSubject(subjectId);
                    }
                }
            });
        }

        // 设置分类悬停事件
        function setupCategoryHover() {
            // 视频分类悬停事件
            const videoBtn = document.getElementById('videoCategoryBtn');
            const videoDropdown = document.getElementById('videoSubjectDropdown');
            const videoContainer = videoBtn ? videoBtn.parentElement : null;
            
            if (videoBtn && videoDropdown && videoContainer) {
                let hideTimeout;
                
                videoContainer.addEventListener('mouseenter', function() {
                    clearTimeout(hideTimeout);
                    // 加载学科数据
                    loadSubjects();
                    videoDropdown.classList.add('show');
                });
                
                videoContainer.addEventListener('mouseleave', function(e) {
                    hideTimeout = setTimeout(() => {
                        if (!videoDropdown.matches(':hover')) {
                            hideSubjectDropdown(videoDropdown);
                        }
                    }, 300); // 延迟300ms隐藏
                });
                
                videoDropdown.addEventListener('mouseenter', function() {
                    clearTimeout(hideTimeout);
                });
                
                videoDropdown.addEventListener('mouseleave', function() {
                    hideTimeout = setTimeout(() => {
                        hideSubjectDropdown(videoDropdown);
                    }, 300);
                });
            }
            
            // 习题分类悬停事件
            const exerciseBtn = document.getElementById('exerciseCategoryBtn');
            const exerciseDropdown = document.getElementById('exerciseSubjectDropdown');
            const exerciseContainer = exerciseBtn ? exerciseBtn.parentElement : null;
            
            if (exerciseBtn && exerciseDropdown && exerciseContainer) {
                let hideTimeout;
                
                exerciseContainer.addEventListener('mouseenter', function() {
                    clearTimeout(hideTimeout);
                    // 加载学科数据
                    loadSubjects();
                    exerciseDropdown.classList.add('show');
                });
                
                exerciseContainer.addEventListener('mouseleave', function(e) {
                    hideTimeout = setTimeout(() => {
                        if (!exerciseDropdown.matches(':hover')) {
                            hideSubjectDropdown(exerciseDropdown);
                        }
                    }, 300); // 延迟300ms隐藏
                });
                
                exerciseDropdown.addEventListener('mouseenter', function() {
                    clearTimeout(hideTimeout);
                });
                
                exerciseDropdown.addEventListener('mouseleave', function() {
                    hideTimeout = setTimeout(() => {
                        hideSubjectDropdown(exerciseDropdown);
                    }, 300);
                });
            }
        }

        // 隐藏指定的学科下拉菜单
        function hideSubjectDropdown(dropdown) {
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }
        
        // 隐藏所有学科下拉菜单
        function hideAllSubjectDropdowns() {
            const dropdowns = document.querySelectorAll('.subject-dropdown');
            dropdowns.forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }

        // 渲染学科下拉菜单
        function renderSubjectDropdown() {
            // 渲染视频学科下拉菜单
            const videoDropdown = document.getElementById('videoSubjectDropdown');
            if (videoDropdown) {
                renderSingleDropdown(videoDropdown);
            }
            
            // 渲染习题学科下拉菜单
            const exerciseDropdown = document.getElementById('exerciseSubjectDropdown');
            if (exerciseDropdown) {
                renderSingleDropdown(exerciseDropdown);
            }
        }
        
        // 渲染单个下拉菜单
        function renderSingleDropdown(dropdown) {
            console.log('渲染下拉菜单，学科数据:', subjectsData);
            
            if (subjectsData.length === 0) {
                console.log('没有学科数据可显示');
                return;
            }
            
            const subjectItems = subjectsData.map(subject => {
                // 确保获取正确的字段
                const subjectId = subject.id_s || subject.id || '';
                const subjectName = subject.subject || subject.name || '未知学科';
                
                console.log(`学科项: ID=${subjectId}, 名称=${subjectName}`);
                
                return `
                    <div class="subject-item" data-subject-id="${subjectId}">
                        ${subjectName}
                    </div>
                `;
            }).join('');
            
            // 保留"全部学科"选项并添加新选项
            const allSubjectItem = dropdown.querySelector('[data-subject-id="all"]');
            dropdown.innerHTML = '';
            if (allSubjectItem) {
                dropdown.appendChild(allSubjectItem);
            }
            dropdown.innerHTML += subjectItems;
            
            console.log('下拉菜单渲染完成');
        }

        // 按分类筛选
        function filterByCategory(category) {
            if (category === 'all') {
                currentResources = [...resourcesData];
            } else {
                // 映射新的分类名称到原有数据结构
                let mappedCategory = category;
                if (category === 'exercise') mappedCategory = 'exercise';
                else if (category === 'other') mappedCategory = 'other';
                else if (category === 'video') mappedCategory = 'video';
                
                currentResources = resourcesData.filter(resource => resource.category === mappedCategory);
            }
            currentPage = 1;
            renderResources();
        }

        // 按视频学科筛选
        function filterByVideoSubject(subjectId) {
            if (subjectId === 'all') {
                // 如果选择了全部学科，显示所有视频资源
                currentResources = resourcesData.filter(resource => resource.category === 'video');
            } else {
                // 按学科ID筛选视频资源
                currentResources = resourcesData.filter(resource => 
                    resource.category === 'video' && 
                    String(resource.subject_id) === String(subjectId)
                );
            }
            currentPage = 1;
            renderResources();
        }
        
        // 按习题学科筛选
        function filterByExerciseSubject(subjectId) {
            if (subjectId === 'all') {
                // 如果选择了全部学科，显示所有习题资源
                currentResources = resourcesData.filter(resource => resource.category === 'exercise');
            } else {
                // 按学科ID筛选习题资源
                currentResources = resourcesData.filter(resource => 
                    resource.category === 'exercise' && 
                    String(resource.subject_id) === String(subjectId)
                );
            }
            currentPage = 1;
            renderResources();
        }

        // 按搜索词筛选
        function filterBySearch(searchTerm) {
            currentResources = resourcesData.filter(resource => 
                resource.title.toLowerCase().includes(searchTerm) ||
                resource.description.toLowerCase().includes(searchTerm) ||
                resource.tags.some(tag => tag.toLowerCase().includes(searchTerm))
            );
            currentPage = 1;
            renderResources();
        }

        // 排序
        function sortBy(sortType) {
            switch(sortType) {
                case 'latest':
                    currentResources.sort((a, b) => new Date(b.date) - new Date(a.date));
                    break;
                case 'popular':
                    currentResources.sort((a, b) => b.downloads - a.downloads);
                    break;
                case 'rating':
                    currentResources.sort((a, b) => b.rating - a.rating);
                    break;
            }
            renderResources();
        }

        // 渲染资源卡片
        function renderResources() {
            const grid = document.getElementById('resourcesGrid');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageResources = currentResources.slice(startIndex, endIndex);

            grid.innerHTML = pageResources.map(resource => `
                <div class="resource-card">
                    <div class="resource-header">
                        <div class="resource-icon">
                            <i class="${resource.icon}"></i>
                        </div>
                        <span class="resource-type">${resource.type}</span>
                    </div>
                    <h3 class="resource-title">${resource.title}</h3>
                    <p class="resource-description">${resource.description}</p>
                    <div class="resource-meta">
                        <div class="resource-tags">
                            ${resource.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                        <div>
                            <span><i class="fas fa-download"></i> ${resource.downloads.toLocaleString()}</span>
                            <span style="margin-left: 1rem;"><i class="fas fa-star"></i> ${resource.rating}</span>
                        </div>
                    </div>
                    <div class="resource-actions">
                        <a href="#" class="action-btn primary-btn" onclick="downloadResource(${resource.id})">
                            <i class="fas fa-download"></i> 下载
                        </a>
                        <a href="#" class="action-btn secondary-btn" onclick="viewResource(${resource.id})">
                            <i class="fas fa-eye"></i> 查看详情
                        </a>
                    </div>
                </div>
            `).join('');

            renderPagination();
        }

        // 渲染分页控件
        function renderPagination() {
            const totalPages = Math.ceil(currentResources.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = '';
            
            // 上一页按钮
            if (currentPage > 1) {
                paginationHTML += `<button class="page-btn" onclick="changePage(${currentPage - 1})"><i class="fas fa-chevron-left"></i></button>`;
            }

            // 页码按钮
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationHTML += `<button class="page-btn active">${i}</button>`;
                } else {
                    paginationHTML += `<button class="page-btn" onclick="changePage(${i})">${i}</button>`;
                }
            }

            // 下一页按钮
            if (currentPage < totalPages) {
                paginationHTML += `<button class="page-btn" onclick="changePage(${currentPage + 1})"><i class="fas fa-chevron-right"></i></button>`;
            }

            pagination.innerHTML = paginationHTML;
        }

        // 切换页面
        function changePage(page) {
            currentPage = page;
            renderResources();
            // 滚动到顶部
            document.querySelector('.resources-section').scrollIntoView({ behavior: 'smooth' });
        }

        // 下载资源
        function downloadResource(id) {
            const resource = resourcesData.find(r => r.id === id);
            alert(`正在下载资源：${resource.title}\n请稍候...`);
            // 这里可以添加实际的下载逻辑
        }

        // 检查用户登录状态
        async function checkLoginStatus() {
            try {
                const response = await fetch('/api/current_user');
                if (response.ok) {
                    const result = await response.json();
                    return result.success;
                }
                return false;
            } catch (error) {
                console.log('检查登录状态失败:', error);
                return false;
            }
        }

        // 显示通知消息
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                animation: slideIn 0.3s ease;
            `;
            
            switch(type) {
                case 'success':
                    notification.style.background = '#48BB78';
                    break;
                case 'error':
                    notification.style.background = '#F56565';
                    break;
                case 'warning':
                    notification.style.background = '#ED8936';
                    break;
                default:
                    notification.style.background = '#38B2AC';
            }
            
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            // 3秒后自动移除
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // 查看资源详情
        async function viewResource(id) {
            const resource = resourcesData.find(r => r.id === id);
            
            // 检查登录状态
            const isLoggedIn = await checkLoginStatus();
            
            if (!isLoggedIn) {
                // 未登录，显示提示并跳转到注册页面
                showNotification('请先登录后再查看资源详情', 'warning');
                setTimeout(() => {
                    window.location.href = '/register';
                }, 1500);
                return;
            }
            
            // 已登录，根据资源类型决定跳转方式
            if (resource.category === 'video') {
                // 视频资源跳转到视频播放页面
                window.location.href = `/video-player?id=${id}`;
            } else {
                // 其他资源显示弹窗信息
                alert(`资源详情：${resource.title}

描述：${resource.description}

标签：${resource.tags.join(', ')}`);
            }
        }

        // 返回学习平台
        function goBack() {
            window.location.href = '/learning-platform';
        }
    </script>
</body>
</html>