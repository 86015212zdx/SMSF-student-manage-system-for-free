<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹¼å†™æ¼«æ¸¸ - SMSF è‹±è¯­å­¦ä¹ å¹³å°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="/static/OKComputer_ä¼ä¸šåŒ–ç½‘é¡µé‡è®¾/utils.js"></script>
    <link rel="stylesheet" href="/static/zt/fonts.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans SC', 'Quattrocento Sans', sans-serif;
        }

        body {
            background: #1A202C;
            color: #E2E8F0;
            min-height: 100vh;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        nav {
            background: #2D3748;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #4A5568;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }

        .logo-text {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #38B2AC 0%, #4FD1C7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'Chiron Hei HK', sans-serif;
        }

        .nav-back {
            background: #4A5568;
            color: #A0AEC0;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-back:hover {
            background: #38B2AC;
            color: #1A202C;
        }

        /* ä¸»è¦å†…å®¹åŒºåŸŸ */
        .main-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .page-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2.2rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #38B2AC 0%, #4FD1C7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'Chiron Hei HK', sans-serif;
            font-weight: 700;
        }

        .page-subtitle {
            font-size: 1rem;
            color: #A0AEC0;
        }

        /* æ¸¸æˆåŒºåŸŸ */
        .game-area {
            background: #2D3748;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid #4A5568;
        }

        .progress-container {
            margin-bottom: 2rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #A0AEC0;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #4A5568;
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #38B2AC 0%, #4FD1C7 100%);
            width: 0%;
            transition: width 0.5s ease;
        }

        /* å•è¯æ˜¾ç¤ºåŒºåŸŸ */
        .word-display-area {
            text-align: center;
            margin: 2rem 0;
            padding: 2rem;
            background: #1A202C;
            border-radius: 12px;
            border: 1px solid #4A5568;
        }

        .chinese-definition {
            font-size: 1.4rem;
            color: #E2E8F0;
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .phonetic-display {
            font-size: 1.1rem;
            color: #A0AEC0;
            font-style: italic;
            margin-bottom: 2rem;
        }

        /* æ‹¼å†™è¾“å…¥åŒºåŸŸ */
        .spelling-input-area {
            margin: 2rem 0;
        }

        .underline-container {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            margin: 2rem 0;
            min-height: 60px;
            align-items: center;
        }

        .letter-underline {
            position: relative;
            width: 40px;
            height: 50px;
            border-bottom: 3px solid #4A5568;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: 700;
            color: #E2E8F0;
            transition: all 0.3s ease;
        }

        .letter-underline.filled {
            border-bottom-color: #38B2AC;
            color: #38B2AC;
        }

        .letter-underline.correct {
            border-bottom-color: #48BB78;
            color: #48BB78;
        }

        .letter-underline.incorrect {
            border-bottom-color: #E53E3E;
            color: #E53E3E;
        }

        .letter-underline.current {
            border-bottom-color: #ED8936;
            box-shadow: 0 0 10px rgba(237, 137, 54, 0.5);
        }

        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .control-button {
            background: #4A5568;
            color: #E2E8F0;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .control-button:hover {
            background: #38B2AC;
            color: #1A202C;
            transform: translateY(-2px);
        }

        .control-button.primary {
            background: #38B2AC;
            color: #1A202C;
        }

        .control-button.primary:hover {
            background: #4FD1C7;
        }

        .control-button.success {
            background: #48BB78;
            color: #1A202C;
        }

        .control-button.danger {
            background: #E53E3E;
            color: #FFFFFF;
        }

        /* ç»“æœåé¦ˆ */
        .feedback {
            text-align: center;
            margin: 1rem 0;
            min-height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .feedback-message {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            display: none;
        }

        .feedback-message.success {
            background: rgba(72, 187, 120, 0.2);
            color: #48BB78;
            border: 1px solid #48BB78;
        }

        .feedback-message.error {
            background: rgba(229, 62, 62, 0.2);
            color: #E53E3E;
            border: 1px solid #E53E3E;
        }

        .feedback-message.show {
            display: inline-block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ç»Ÿè®¡ä¿¡æ¯ */
        .stats-panel {
            background: #2D3748;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
            border: 1px solid #4A5568;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            text-align: center;
        }

        .stat-item {
            padding: 1rem;
            background: #1A202C;
            border-radius: 8px;
            border: 1px solid #4A5568;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #38B2AC;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #A0AEC0;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .main-container {
                padding: 0 1rem;
            }
            
            .page-title {
                font-size: 1.8rem;
            }
            
            .letter-underline {
                width: 30px;
                height: 40px;
                font-size: 1.5rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .control-button {
                width: 100%;
                max-width: 250px;
            }
        }

        @media (max-width: 480px) {
            nav {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }
            
            .logo-text {
                font-size: 1.5rem;
            }
            
            .page-title {
                font-size: 1.6rem;
            }
            
            .letter-underline {
                width: 25px;
                height: 35px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav>
        <div class="logo-section">
            <img src="resource_web/logo_64.png" alt="SMSF Logo" class="logo-icon">
            <div class="logo-text">æ‹¼å†™æ¼«æ¸¸</div>
        </div>
        
        <button class="nav-back" id="backButton">
            <i class="fas fa-arrow-left"></i>
            è¿”å›è®­ç»ƒä¸­å¿ƒ
        </button>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="main-container">
        <div class="page-header">
            <h1 class="page-title">æ‹¼å†™æ¼«æ¸¸</h1>
            <p class="page-subtitle">æ ¹æ®ä¸­æ–‡é‡Šä¹‰å’ŒéŸ³æ ‡ï¼Œæ‹¼å†™å‡ºæ­£ç¡®çš„è‹±æ–‡å•è¯</p>
        </div>

        <!-- æ¸¸æˆåŒºåŸŸ -->
        <div class="game-area">
            <!-- å·²å®Œæˆè®¡æ•° -->
            <div class="progress-container">
                <div class="progress-header">
                    <span>å·²å®Œæˆ</span>
                    <span id="completedCount">0</span>
                </div>
            </div>

            <!-- å•è¯æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="word-display-area">
                <div class="chinese-definition" id="chineseDefinition">
                    æ­£åœ¨åŠ è½½å•è¯...
                </div>
                <div class="phonetic-display" id="phoneticDisplay">
                    éŸ³æ ‡åŠ è½½ä¸­...
                </div>
            </div>

            <!-- æ‹¼å†™è¾“å…¥åŒºåŸŸ -->
            <div class="spelling-input-area">
                <div class="underline-container" id="underlineContainer">
                    <!-- åŠ¨æ€ç”Ÿæˆä¸‹åˆ’çº¿ -->
                </div>
            </div>

            <!-- åé¦ˆä¿¡æ¯ -->
            <div class="feedback">
                <div class="feedback-message success" id="successMessage">
                    ğŸ‰ æ­å–œï¼æ‹¼å†™æ­£ç¡®ï¼
                </div>
                <div class="feedback-message error" id="errorMessage">
                    âŒ æ‹¼å†™é”™è¯¯ï¼Œè¯·é‡è¯•
                </div>
            </div>

            <!-- æ§åˆ¶æŒ‰é’® -->
            <div class="controls">
                <button class="control-button" onclick="clearInput()">
                    <i class="fas fa-eraser"></i>
                    æ¸…ç©º
                </button>
                <button class="control-button" onclick="showHint()">
                    <i class="fas fa-lightbulb"></i>
                    æç¤º
                </button>
                <button class="control-button primary" onclick="checkAnswer()" id="checkButton">
                    <i class="fas fa-check"></i>
                    æ£€æŸ¥ç­”æ¡ˆ
                </button>
                <button class="control-button danger" onclick="showAnswer()" id="answerButton">
                    <i class="fas fa-eye"></i>
                    æŸ¥çœ‹ç­”æ¡ˆ
                </button>
            </div>
        </div>

        <!-- ç»Ÿè®¡é¢æ¿ -->
        <div class="stats-panel">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="correctCount">0</div>
                    <div class="stat-label">æ­£ç¡®</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="wrongCount">0</div>
                    <div class="stat-label">é”™è¯¯</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="accuracyRate">0%</div>
                    <div class="stat-label">å‡†ç¡®ç‡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="currentStreak">0</div>
                    <div class="stat-label">è¿ç»­æ­£ç¡®</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let wordList = [];
        let currentIndex = 0;
        let userInput = [];
        let correctCount = 0;
        let wrongCount = 0;
        let currentStreak = 0;
        let totalLetters = 0;
        // é¢„åŠ è½½ç›¸å…³å˜é‡
        let nextWordList = [];
        let isPreloading = false;
        // ç´¯è®¡è®¡æ•°å™¨
        let totalCompletedCount = 0;

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åˆå§‹åŒ–å¼€å§‹');
            loadWords();
            setupKeyboardListener();
            
            // æ·»åŠ è¿”å›æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            const backButton = document.getElementById('backButton');
            if (backButton) {
                backButton.addEventListener('click', async function() {
                    await goBack();
                });
            }
            
            console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        });

        // ä»APIåŠ è½½å•è¯æ•°æ®
        async function loadWords() {
            try {
                // è°ƒç”¨APIè·å–æŒ‡å®šç­‰çº§çš„å•è¯
                const response = await fetch('/api/read_some_word_form_certain_level');
                const result = await response.json();
                
                // æ£€æŸ¥APIå“åº”æ ¼å¼
                if (result && result.success === true && Array.isArray(result.words)) {
                    wordList = result.words;
                    currentIndex = 0;
                    displayCurrentWord();
                    updateProgress();
                    updateStats();
                    console.log('æˆåŠŸåŠ è½½å•è¯æ•°æ®:', wordList);
                    
                    // å¼€å§‹é¢„åŠ è½½ä¸‹ä¸€è½®æ•°æ®
                    preloadNextRound();
                } else {
                    console.warn('APIè¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œä½¿ç”¨ç¤ºä¾‹æ•°æ®');
                    loadSampleData();
                }
            } catch (error) {
                console.error('åŠ è½½å•è¯æ•°æ®å¤±è´¥:', error);
                loadSampleData();
            }
        }

        // åŠ è½½ç¤ºä¾‹æ•°æ®
        function loadSampleData() {
            wordList = [
                {'word': 'sleek', 'chinese_definition': 'adj. å…‰æ»‘çš„ï¼›æ—¶é«¦çš„ï¼›v. ä½¿å…‰æ»‘ï¼›ä½¿æ•´æ´', 'phonetic': 'sli:k'},
                {'word': 'adjacent', 'chinese_definition': 'adj. ç›¸é‚»çš„ï¼›é‚»è¿‘çš„', 'phonetic': "Ó™'dÊ’eisÓ™nt"},
                {'word': 'competent', 'chinese_definition': 'adj. æœ‰èƒ½åŠ›çš„ï¼›èƒœä»»çš„ï¼›ç§°èŒçš„', 'phonetic': "'kÉ’mpitÓ™nt"},
                {'word': 'bewilder', 'chinese_definition': 'v. ä½¿å›°æƒ‘ï¼›ä½¿è¿·æƒ‘', 'phonetic': "bi'wildÓ™"},
                {'word': 'embryo', 'chinese_definition': 'n. èƒšèƒï¼›èƒšèŠ½ï¼›adj. èƒšèƒçš„ï¼›åˆæœŸçš„', 'phonetic': "'embriÓ™u"},
                {'word': 'assign', 'chinese_definition': 'v. åˆ†é…ï¼›æŒ‡æ´¾ï¼›å¸ƒç½®ï¼›è½¬è®©', 'phonetic': "Ó™'sain"},
                {'word': 'laundry', 'chinese_definition': 'n. æ´—è¡£åº—ï¼›è¦æ´—çš„è¡£ç‰©ï¼›æ´—è¡£ï¼›æ´—æ¶¤', 'phonetic': "'lÉ’:ndri"},
                {'word': 'ideal', 'chinese_definition': 'adj. ç†æƒ³çš„ï¼›å®Œç¾çš„ï¼›ï¼ˆä¸»ä¹‰ï¼‰ç†æƒ³ä¸»ä¹‰çš„ï¼›n. ç†æƒ³ï¼›å…¸èŒƒ', 'phonetic': "ai'diÓ™l"},
                {'word': 'sociology', 'chinese_definition': 'n. ç¤¾ä¼šå­¦ï¼›ç¤¾ä¼šç ”ç©¶ï¼›ç¤¾ä¼šç§‘å­¦', 'phonetic': ".sÓ™usi'É’lÓ™dÊ’i"},
                {'word': 'consortium', 'chinese_definition': 'n. è´¢å›¢ï¼›è”åˆä¼ä¸šï¼›è”ç›Ÿ', 'phonetic': "kÓ™n'sÉ’:tjÓ™m"}
            ];
            currentIndex = 0;
            displayCurrentWord();
            updateProgress();
            updateStats();
        }

        // æ˜¾ç¤ºå½“å‰å•è¯
        function displayCurrentWord() {
            console.log('displayCurrentWord called, wordList length:', wordList.length, 'currentIndex:', currentIndex);
            console.log('é¢„åŠ è½½æ•°æ®çŠ¶æ€: nextWordList length:', nextWordList.length, 'isPreloading:', isPreloading);
            if (wordList.length === 0) return;
            
            const currentWord = wordList[currentIndex];
            if (!currentWord) return;
            console.log('å½“å‰å•è¯:', currentWord);
            
            // æ˜¾ç¤ºä¸­æ–‡é‡Šä¹‰
            const chineseElement = document.getElementById('chineseDefinition');
            if (chineseElement) {
                chineseElement.textContent = currentWord.chinese_definition;
            }
            
            // æ˜¾ç¤ºéŸ³æ ‡
            const phoneticElement = document.getElementById('phoneticDisplay');
            if (phoneticElement) {
                phoneticElement.textContent = `[${currentWord.phonetic}]`;
            }
            
            // åˆ›å»ºä¸‹åˆ’çº¿å®¹å™¨
            createUnderlineContainers(currentWord.word);
            
            // é‡ç½®ç”¨æˆ·è¾“å…¥
            userInput = [];
            resetUnderlines();
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            const checkButton = document.getElementById('checkButton');
            const answerButton = document.getElementById('answerButton');
            if (checkButton) checkButton.style.display = 'flex';
            if (answerButton) answerButton.style.display = 'flex';
            
            // éšè—åé¦ˆæ¶ˆæ¯
            hideFeedback();
        }

        // åˆ›å»ºä¸‹åˆ’çº¿å®¹å™¨
        function createUnderlineContainers(word) {
            const container = document.getElementById('underlineContainer');
            container.innerHTML = '';
            
            totalLetters = word.length;
            
            for (let i = 0; i < totalLetters; i++) {
                const underline = document.createElement('div');
                underline.className = 'letter-underline';
                underline.dataset.index = i;
                container.appendChild(underline);
            }
        }

        // é‡ç½®ä¸‹åˆ’çº¿æ ·å¼
        function resetUnderlines() {
            const underlines = document.querySelectorAll('.letter-underline');
            underlines.forEach((underline, index) => {
                underline.textContent = '';
                underline.className = 'letter-underline';
                if (index === 0) {
                    underline.classList.add('current');
                }
            });
        }

        // è®¾ç½®é”®ç›˜ç›‘å¬å™¨
        function setupKeyboardListener() {
            document.addEventListener('keydown', function(e) {
                // åªåœ¨æ¸¸æˆåŒºåŸŸå†…å“åº”é”®ç›˜äº‹ä»¶
                if (document.activeElement.tagName !== 'INPUT' && 
                    document.activeElement.tagName !== 'TEXTAREA') {
                    
                    // å¤„ç†å­—æ¯è¾“å…¥
                    if (/^[a-zA-Z]$/.test(e.key)) {
                        handleLetterInput(e.key.toLowerCase());
                    }
                    // å¤„ç†é€€æ ¼é”®
                    else if (e.key === 'Backspace') {
                        handleBackspace();
                    }
                    // å¤„ç†ç©ºæ ¼é”®ï¼ˆæ¸…ç©ºï¼‰
                    else if (e.key === ' ') {
                        e.preventDefault();
                        clearInput();
                    }
                    // å¤„ç†å›è½¦é”®ï¼ˆæ£€æŸ¥ç­”æ¡ˆï¼‰
                    else if (e.key === 'Enter') {
                        checkAnswer();
                    }
                }
            });
        }

        // å¤„ç†å­—æ¯è¾“å…¥
        function handleLetterInput(letter) {
            if (userInput.length < totalLetters) {
                userInput.push(letter);
                updateUnderlineDisplay();
                
                // å¦‚æœè¾“å…¥å®Œæˆï¼Œè‡ªåŠ¨æ£€æŸ¥ç­”æ¡ˆ
                if (userInput.length === totalLetters) {
                    setTimeout(checkAnswer, 300);
                }
            }
        }

        // å¤„ç†é€€æ ¼é”®
        function handleBackspace() {
            if (userInput.length > 0) {
                userInput.pop();
                updateUnderlineDisplay();
                // æ¸…ç©ºæœ€åä¸€ä¸ªå­—æ¯æ¡†
                clearLastUnderline();
            }
        }

        // æ›´æ–°ä¸‹åˆ’çº¿æ˜¾ç¤º
        function updateUnderlineDisplay() {
            const underlines = document.querySelectorAll('.letter-underline');
            const currentWord = wordList[currentIndex].word.toLowerCase();
            
            underlines.forEach((underline, index) => {
                // é‡ç½®æ ·å¼
                underline.className = 'letter-underline';
                
                if (index < userInput.length) {
                    // å·²è¾“å…¥çš„å­—æ¯
                    const userLetter = userInput[index];
                    const correctLetter = currentWord[index];
                    
                    underline.textContent = userLetter;
                    
                    if (userLetter === correctLetter) {
                        underline.classList.add('correct');
                    } else {
                        underline.classList.add('incorrect');
                    }
                } else if (index === userInput.length) {
                    // å½“å‰è¾“å…¥ä½ç½®
                    underline.classList.add('current');
                }
            });
        }

        // æ£€æŸ¥ç­”æ¡ˆ
        function checkAnswer() {
            if (userInput.length === 0) {
                showMessage('è¯·å…ˆè¾“å…¥å•è¯', 'error');
                return;
            }
            
            const currentWord = wordList[currentIndex].word.toLowerCase();
            const userWord = userInput.join('').toLowerCase();
            
            if (userWord === currentWord) {
                // ç­”æ¡ˆæ­£ç¡®
                correctCount++;
                currentStreak++;
                
                // é«˜äº®æ˜¾ç¤ºæ‰€æœ‰æ­£ç¡®å­—æ¯
                highlightAllCorrect();
                
                // ç›´æ¥è·³è½¬åˆ°ä¸‹ä¸€ä¸ªå•è¯
                setTimeout(nextWord, 800);
                
            } else {
                // ç­”æ¡ˆé”™è¯¯ - å¢åŠ é”™è¯¯è®¡æ•°
                wrongCount++;
                currentStreak = 0;
                showMessage('âŒ æ‹¼å†™é”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
                
                // é«˜äº®æ˜¾ç¤ºé”™è¯¯å­—æ¯
                highlightErrors();
            }
            
            updateStats();
        }

        // é«˜äº®æ‰€æœ‰æ­£ç¡®å­—æ¯
        function highlightAllCorrect() {
            const underlines = document.querySelectorAll('.letter-underline');
            underlines.forEach(underline => {
                underline.classList.remove('incorrect', 'current');
                underline.classList.add('correct');
            });
        }

        // é«˜äº®é”™è¯¯å­—æ¯
        function highlightErrors() {
            const underlines = document.querySelectorAll('.letter-underline');
            const currentWord = wordList[currentIndex].word.toLowerCase();
            
            underlines.forEach((underline, index) => {
                if (index < userInput.length) {
                    const userLetter = userInput[index];
                    const correctLetter = currentWord[index];
                    
                    if (userLetter !== correctLetter) {
                        underline.classList.add('incorrect');
                    }
                }
            });
        }

        // æ¸…ç©ºæœ€åä¸€ä¸ªå­—æ¯æ¡†
        function clearLastUnderline() {
            const underlines = document.querySelectorAll('.letter-underline');
            if (underlines.length > userInput.length) {
                const lastUnderline = underlines[userInput.length];
                if (lastUnderline) {
                    lastUnderline.textContent = '';
                    lastUnderline.className = 'letter-underline';
                    // è®¾ç½®å½“å‰è¾“å…¥ä½ç½®é«˜äº®
                    if (userInput.length < underlines.length) {
                        underlines[userInput.length].classList.add('current');
                    }
                }
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type) {
            hideFeedback();
            
            const messageElement = document.getElementById(type === 'success' ? 'successMessage' : 'errorMessage');
            messageElement.textContent = text;
            messageElement.classList.add('show');
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                messageElement.classList.remove('show');
            }, 3000);
        }

        // éšè—åé¦ˆæ¶ˆæ¯
        function hideFeedback() {
            document.getElementById('successMessage').classList.remove('show');
            document.getElementById('errorMessage').classList.remove('show');
        }

        // æ¸…ç©ºè¾“å…¥
        function clearInput() {
            userInput = [];
            resetUnderlines();
            hideFeedback();
        }

        // æ˜¾ç¤ºæç¤º
        function showHint() {
            const currentWord = wordList[currentIndex].word;
            const hintLength = Math.min(2, Math.floor(currentWord.length / 2));
            let hint = '';
            
            for (let i = 0; i < currentWord.length; i++) {
                if (i < hintLength) {
                    hint += currentWord[i];
                } else {
                    hint += '_';
                }
            }
            
            showMessage(`ğŸ’¡ æç¤º: ${hint}`, 'success');
        }

        // æ˜¾ç¤ºç­”æ¡ˆ
        function showAnswer() {
            const currentWord = wordList[currentIndex].word;
            showMessage(`ğŸ“ æ­£ç¡®ç­”æ¡ˆ: ${currentWord}`, 'error');
            
            // ç”¨æˆ·æŸ¥çœ‹ç­”æ¡ˆæ—¶å¢åŠ é”™è¯¯è®¡æ•°
            wrongCount++;
            updateStats();
        }

        // ä¸‹ä¸€ä¸ªå•è¯
        function nextWord() {
            if (currentIndex < wordList.length - 1) {
                currentIndex++;
                displayCurrentWord();
                updateProgress();
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦é¢„åŠ è½½ä¸‹ä¸€è½®
                if (currentIndex === wordList.length - 3) { // ç¬¬8ä¸ªå•è¯æ—¶å¼€å§‹é¢„åŠ è½½
                    preloadNextRound();
                }
            } else {
                // å®Œæˆæ‰€æœ‰å•è¯ï¼Œå¦‚æœæœ‰é¢„åŠ è½½æ•°æ®åˆ™åˆ‡æ¢
                if (nextWordList.length > 0) {
                    switchToNextRound();
                } else {
                    // å®Œæˆæ‰€æœ‰å•è¯
                    showCompletion();
                }
            }
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            // åªæ˜¾ç¤ºå·²å®Œæˆçš„æ•°é‡ï¼ˆç´¯è®¡ï¼‰
            const completedElement = document.getElementById('completedCount');
            if (completedElement) {
                completedElement.textContent = totalCompletedCount + currentIndex;
            }
        }
        
        // é¢„åŠ è½½ä¸‹ä¸€è½®æ•°æ®
        async function preloadNextRound() {
            if (isPreloading) return; // é¿å…é‡å¤é¢„åŠ è½½
            
            isPreloading = true;
            console.log('å¼€å§‹é¢„åŠ è½½ä¸‹ä¸€è½®æ•°æ®...');
            
            try {
                const response = await fetch('/api/read_some_word_form_certain_level');
                const result = await response.json();
                
                if (result && result.success === true && Array.isArray(result.words)) {
                    nextWordList = result.words;
                    console.log('é¢„åŠ è½½å®Œæˆï¼Œä¸‹ä¸€è½®æ•°æ®:', nextWordList);
                } else {
                    console.warn('é¢„åŠ è½½æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }
            } catch (error) {
                console.error('é¢„åŠ è½½æ•°æ®å¤±è´¥:', error);
            } finally {
                isPreloading = false;
            }
        }
        
        // åˆ‡æ¢åˆ°ä¸‹ä¸€è½®æ•°æ®
        function switchToNextRound() {
            console.log('åˆ‡æ¢åˆ°ä¸‹ä¸€è½®æ•°æ®');
            
            // ç´¯è®¡å·²å®Œæˆçš„å•è¯æ•°é‡
            totalCompletedCount += wordList.length;
            
            wordList = nextWordList;
            currentIndex = 0;
            nextWordList = [];
            
            // é‡ç½®è¾“å…¥çŠ¶æ€
            userInput = [];
            
            // æ˜¾ç¤ºæ–°å•è¯
            displayCurrentWord();
            updateProgress();
            
            // å¼€å§‹é¢„åŠ è½½å†ä¸‹ä¸€è½®
            preloadNextRound();
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('correctCount').textContent = correctCount;
            document.getElementById('wrongCount').textContent = wrongCount;
            document.getElementById('currentStreak').textContent = currentStreak;
            
            const totalAttempts = correctCount + wrongCount;
            const accuracyRate = totalAttempts > 0 ? Math.round((correctCount / totalAttempts) * 100) : 0;
            document.getElementById('accuracyRate').textContent = `${accuracyRate}%`;
        }

        // æ˜¾ç¤ºå®Œæˆç•Œé¢
        function showCompletion() {
            const totalAttempts = correctCount + wrongCount;
            const accuracyRate = totalAttempts > 0 ? Math.round((correctCount / totalAttempts) * 100) : 0;
            
            alert(`ğŸ‰ æ­å–œå®Œæˆæ‹¼å†™æ¼«æ¸¸ï¼

ğŸ“Š ç»Ÿè®¡ç»“æœï¼š
âœ… æ­£ç¡®: ${correctCount}
âŒ é”™è¯¯: ${wrongCount}
ğŸ“ˆ å‡†ç¡®ç‡: ${accuracyRate}%
ğŸ”¥ æœ€å¤§è¿èƒœ: ${currentStreak}`);
            
            // é‡æ–°å¼€å§‹
            restartGame();
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            currentIndex = 0;
            correctCount = 0;
            wrongCount = 0;
            currentStreak = 0;
            totalCompletedCount = 0; // é‡ç½®ç´¯è®¡è®¡æ•°
            userInput = [];
            displayCurrentWord();
            updateProgress();
            updateStats();
        }

        // è¿”å›è®­ç»ƒä¸­å¿ƒ
        async function goBack() {
            // è®¡ç®—ç»éªŒå€¼: æ­£ç¡®è¯æ•°*4 + é”™è¯¯è¯æ•°*2 + è¿å¯¹*2
            const expGained = correctCount * 4 + wrongCount * 2 + currentStreak * 2;
            
            // æ˜¾ç¤ºè·å¾—çš„ç»éªŒå€¼
            if (expGained > 0) {
                alert(`ğŸ‰ æœ¬æ¬¡ç»ƒä¹ è·å¾— ${expGained} ç‚¹ç»éªŒå€¼ï¼

ğŸ“Š ç»ƒä¹ ç»Ÿè®¡ï¼š
âœ… æ­£ç¡®: ${correctCount} (${correctCount * 4} exp)
âŒ é”™è¯¯: ${wrongCount} (${wrongCount * 2} exp)
ğŸ”¥ è¿ç»­æ­£ç¡®: ${currentStreak} (${currentStreak * 2} exp)`);
            }
            
            // å‘æœåŠ¡å™¨å‘é€ç»éªŒå€¼æ›´æ–°è¯·æ±‚
            await updateSpellingExp();
            
            window.location.href = '/static/OKComputer_ä¼ä¸šåŒ–ç½‘é¡µé‡è®¾/vocabulary_training.html';
        }
        
        // æ›´æ–°æ‹¼å†™è®­ç»ƒç»éªŒå€¼
        async function updateSpellingExp() {
            try {
                // è·å–å½“å‰ç”¨æˆ·è´¦æˆ·ï¼ˆä»ä¼šè¯æˆ–å…¶ä»–æ–¹å¼ï¼‰
                // è¿™é‡Œå‡è®¾å¯ä»¥é€šè¿‡æŸç§æ–¹å¼è·å–å½“å‰ç”¨æˆ·è´¦æˆ·
                const account = await getCurrentUserAccount();
                
                if (!account) {
                    console.warn('æ— æ³•è·å–ç”¨æˆ·è´¦æˆ·ä¿¡æ¯');
                    return;
                }
                
                // å‘é€ç»éªŒå€¼æ›´æ–°è¯·æ±‚
                const response = await fetch('/api/update-spelling-exp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        account: account,
                        correct_count: correctCount,
                        wrong_count: wrongCount,
                        streak_count: currentStreak
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('ç»éªŒå€¼æ›´æ–°æˆåŠŸ:', result.message);
                } else {
                    console.error('ç»éªŒå€¼æ›´æ–°å¤±è´¥:', result.message);
                }
                
            } catch (error) {
                console.error('æ›´æ–°ç»éªŒå€¼æ—¶å‡ºç°é”™è¯¯:', error);
            }
        }
        
        // è·å–å½“å‰ç”¨æˆ·è´¦æˆ·çš„è¾…åŠ©å‡½æ•°
        async function getCurrentUserAccount() {
            try {
                // é¦–å…ˆå°è¯•ä»APIè·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
                const response = await fetch('/api/current_user', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.user && data.user.account) {
                        console.log('âœ… é€šè¿‡APIè·å–ç”¨æˆ·è´¦æˆ·æˆåŠŸ:', data.user.account);
                        return data.user.account;
                    }
                }
                
                // æ–¹æ³•1: ä»localStorageè·å–
                const storedAccount = localStorage.getItem('user_account');
                if (storedAccount) {
                    console.log('âœ… é€šè¿‡localStorageè·å–ç”¨æˆ·è´¦æˆ·:', storedAccount);
                    return storedAccount;
                }
                
                // æ–¹æ³•2: ä»å…¨å±€å˜é‡è·å–ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                if (typeof window.currentUser !== 'undefined' && window.currentUser.account) {
                    console.log('âœ… é€šè¿‡å…¨å±€å˜é‡è·å–ç”¨æˆ·è´¦æˆ·:', window.currentUser.account);
                    return window.currentUser.account;
                }
                
                // æ–¹æ³•3: ä»URLå‚æ•°è·å–
                const urlParams = new URLSearchParams(window.location.search);
                const accountParam = urlParams.get('account');
                if (accountParam) {
                    console.log('âœ… é€šè¿‡URLå‚æ•°è·å–ç”¨æˆ·è´¦æˆ·:', accountParam);
                    return accountParam;
                }
                
                // å¦‚æœéƒ½è·å–ä¸åˆ°ï¼Œè¿”å›null
                console.warn('âŒ æ— æ³•è·å–ç”¨æˆ·è´¦æˆ·ä¿¡æ¯');
                return null;
            } catch (error) {
                console.error('è·å–ç”¨æˆ·è´¦æˆ·æ—¶å‡ºç°é”™è¯¯:', error);
                return null;
            }
        }
    </script>
</body>
</html>