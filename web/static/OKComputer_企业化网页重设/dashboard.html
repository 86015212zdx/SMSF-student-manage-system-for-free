<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教学管理系统 - 数据看板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&family=Quattrocento+Sans:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.css">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #1A202C;
            color: #E2E8F0;
        }
        .font-heading {
            font-family: 'Quattrocento Sans', sans-serif;
        }
        .stat-card {
            background: linear-gradient(135deg, #2D3748 0%, #4A5568 100%);
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(56, 178, 172, 0.2);
        }
        .chart-container {
            background: #2D3748;
            border: 1px solid #4A5568;
        }
        .nav-btn {
            transition: all 0.2s ease;
        }
        .nav-btn:hover {
            background-color: #38B2AC;
            color: #1A202C;
        }
        .gradient-text {
            background: linear-gradient(135deg, #38B2AC 0%, #4FD1C7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- 顶部导航栏 -->
    <nav class="bg-gray-800 border-b border-gray-700 px-6 py-4">
        <div class="flex items-center justify-between">
            <!-- Logo和品牌 -->
            <div class="flex items-center space-x-3">
                <img src="resource_web/logo_64.png" alt="SMSF Logo" class="w-10 h-10 object-contain">
                <div>
                    <h1 class="text-xl font-bold font-heading gradient-text">SMAF 智慧管理</h1>
                    <p class="text-xs text-gray-400">Student Management System for Free</p>
                </div>
            </div>

            <!-- 欢迎信息 -->
            <div class="text-center">
                <p class="text-sm text-gray-300">欢迎回来</p>
                <p class="text-lg font-semibold text-white" id="welcomeText">教师</p>
            </div>

            <!-- 导航菜单 -->
            <div class="flex items-center space-x-3">
                <button class="nav-btn px-4 py-2 bg-gray-700 text-gray-200 rounded-lg text-sm font-medium" onclick="location.href='/learning-platform'">
                    <i data-feather="home" class="w-4 h-4 inline mr-2"></i>返回主页
                </button>
                <button class="nav-btn px-4 py-2 bg-gray-700 text-gray-200 rounded-lg text-sm font-medium" onclick="showClasses()">
                    <i data-feather="users" class="w-4 h-4 inline mr-2"></i>班级管理
                </button>
                <button class="nav-btn px-4 py-2 bg-gray-700 text-gray-200 rounded-lg text-sm font-medium" onclick="showExams()">
                    <i data-feather="file-text" class="w-4 h-4 inline mr-2"></i>考试管理
                </button>
                <button class="nav-btn px-4 py-2 bg-gray-700 text-gray-200 rounded-lg text-sm font-medium" onclick="showNotifications()">
                    <i data-feather="bell" class="w-4 h-4 inline mr-2"></i>通知
                </button>
                <button class="nav-btn px-4 py-2 bg-gray-700 text-gray-200 rounded-lg text-sm font-medium" onclick="showSettings()">
                    <i data-feather="settings" class="w-4 h-4 inline mr-2"></i>设置
                </button>
                <button class="nav-btn px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium" onclick="logout()">
                    <i data-feather="log-out" class="w-4 h-4 inline mr-2"></i>退出
                </button>
            </div>
        </div>
    </nav>

    <!-- 主要内容区域 -->
    <main class="p-6">
        <!-- 统计卡片区域 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card rounded-xl p-6 border border-gray-600">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm font-medium">班级总数</p>
                        <p class="text-3xl font-bold text-white mt-2" id="classCount">0</p>
                    </div>
                    <div class="w-12 h-12 bg-teal-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                        <i data-feather="home" class="w-6 h-6 text-teal-400"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center text-sm">
                    <span class="text-green-400 font-medium">+2</span>
                    <span class="text-gray-400 ml-2">本月新增</span>
                </div>
            </div>

            <div class="stat-card rounded-xl p-6 border border-gray-600">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm font-medium">学生总数</p>
                        <p class="text-3xl font-bold text-white mt-2" id="studentCount">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                        <i data-feather="users" class="w-6 h-6 text-blue-400"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center text-sm">
                    <span class="text-green-400 font-medium">+15</span>
                    <span class="text-gray-400 ml-2">本月新增</span>
                </div>
            </div>

            <div class="stat-card rounded-xl p-6 border border-gray-600">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm font-medium">考试总数</p>
                        <p class="text-3xl font-bold text-white mt-2" id="examCount">0</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                        <i data-feather="file-text" class="w-6 h-6 text-purple-400"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center text-sm">
                    <span class="text-green-400 font-medium">+8</span>
                    <span class="text-gray-400 ml-2">本月新增</span>
                </div>
            </div>

            <div class="stat-card rounded-xl p-6 border border-gray-600">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm font-medium">平均及格率</p>
                        <p class="text-3xl font-bold text-white mt-2" id="avgPassRate">0%</p>
                    </div>
                    <div class="w-12 h-12 bg-green-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                        <i data-feather="trending-up" class="w-6 h-6 text-green-400"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center text-sm">
                    <span class="text-green-400 font-medium">+5.2%</span>
                    <span class="text-gray-400 ml-2">较上月</span>
                </div>
            </div>
        </div>

        <!-- 图表分析区域 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- 班级人数分布图 -->
            <div class="chart-container rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-white">班级人数分布</h3>
                    <button class="text-gray-400 hover:text-white transition-colors">
                        <i data-feather="more-vertical" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="h-80">
                    <canvas id="classDistributionChart"></canvas>
                </div>
            </div>

            <!-- 班级科目平均分对比 -->
            <div class="chart-container rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-white">班级科目平均分对比</h3>
                    <button class="text-gray-400 hover:text-white transition-colors">
                        <i data-feather="more-vertical" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="h-80">
                    <canvas id="subjectComparisonChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 快捷操作区域 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <h3 class="text-lg font-semibold text-white mb-4">快捷操作</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <button class="bg-teal-600 hover:bg-teal-700 text-white p-4 rounded-lg transition-colors text-center" onclick="addExam()">
                    <i data-feather="plus-circle" class="w-8 h-8 mx-auto mb-2"></i>
                    <p class="text-sm font-medium">新建考试</p>
                </button>
                <button class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg transition-colors text-center" onclick="addClass()">
                    <i data-feather="plus-square" class="w-8 h-8 mx-auto mb-2"></i>
                    <p class="text-sm font-medium">添加班级</p>
                </button>
                <button class="bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-lg transition-colors text-center" onclick="viewReports()">
                    <i data-feather="bar-chart-2" class="w-8 h-8 mx-auto mb-2"></i>
                    <p class="text-sm font-medium">查看报告</p>
                </button>
                <button class="bg-green-600 hover:bg-green-700 text-white p-4 rounded-lg transition-colors text-center" onclick="exportData()">
                    <i data-feather="download" class="w-8 h-8 mx-auto mb-2"></i>
                    <p class="text-sm font-medium">导出数据</p>
                </button>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-gray-800 border-t border-gray-700 px-6 py-4 mt-8">
        <div class="text-center text-gray-400 text-sm">
            <p>&copy; 2026 SMAF 智慧管理. 专业教学管理解决方案</p>
        </div>
    </footer>

    <script>
        // 初始化图标
        feather.replace();

        // 图表实例
        let classDistributionChart = null;
        let subjectComparisonChart = null;

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            loadStatistics();
            loadChartData();
        });

        // 加载用户信息
        function loadUserInfo() {
            fetch('/api/current_user', {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.user && data.user.account) {
                    document.getElementById('welcomeText').textContent = data.user.account;
                    localStorage.setItem('currentUser', data.user.account);
                } else {
                    document.getElementById('welcomeText').textContent = '教师';
                }
            })
            .catch(error => {
                console.error('获取用户信息失败:', error);
                document.getElementById('welcomeText').textContent = '教师';
            });
        }

        // 加载统计数据
        function loadStatistics() {
            fetch('/api/statistics', {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('classCount').textContent = data.statistics.classCount;
                    document.getElementById('studentCount').textContent = data.statistics.studentCount;
                    document.getElementById('examCount').textContent = data.statistics.examCount;
                    document.getElementById('avgPassRate').textContent = data.statistics.avgPassRate;
                } else {
                    console.error('获取统计数据失败:', data.message);
                    // 如果API调用失败，显示默认值
                    document.getElementById('classCount').textContent = '0';
                    document.getElementById('studentCount').textContent = '0';
                    document.getElementById('examCount').textContent = '0';
                    document.getElementById('avgPassRate').textContent = '0%';
                }
            })
            .catch(error => {
                console.error('获取统计数据失败:', error);
                // 如果API调用失败，显示默认值
                document.getElementById('classCount').textContent = '0';
                document.getElementById('studentCount').textContent = '0';
                document.getElementById('examCount').textContent = '0';
                document.getElementById('avgPassRate').textContent = '0%';
            });
        }

        // 加载图表数据
        function loadChartData() {
            // 获取班级分布数据
            fetch('/api/class-distribution', {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(distributionData => {
                if (distributionData.success) {
                    // 班级人数分布图
                    const ctx1 = document.getElementById('classDistributionChart').getContext('2d');
                    if (classDistributionChart) {
                        classDistributionChart.destroy();
                    }
                    classDistributionChart = new Chart(ctx1, {
                        type: 'doughnut',
                        data: {
                            labels: distributionData.distribution.classNames,
                            datasets: [{
                                data: distributionData.distribution.studentCounts,
                                backgroundColor: [
                                    '#38B2AC', '#4299E1', '#9F7AEA', '#ED8936', '#48BB78', '#F56565',
                                    '#8B5CF6', '#EC4899', '#F43F5E', '#F59E0B', '#10B981', '#3B82F6'
                                ],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: '#E2E8F0',
                                        padding: 20,
                                        font: {
                                            size: 12
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            })
            .catch(error => {
                console.error('获取班级分布数据失败:', error);
            });

            // 获取科目对比数据
            fetch('/api/subject-comparison', {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(subjectData => {
                if (subjectData.success) {
                    // 班级科目平均分对比图
                    const ctx2 = document.getElementById('subjectComparisonChart').getContext('2d');
                    if (subjectComparisonChart) {
                        subjectComparisonChart.destroy();
                    }
                    subjectComparisonChart = new Chart(ctx2, {
                        type: 'bar',
                        data: {
                            labels: subjectData.comparison.subjects,
                            datasets: subjectData.comparison.datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        color: '#E2E8F0',
                                        font: {
                                            size: 12
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        color: '#A0AEC0'
                                    },
                                    grid: {
                                        color: '#4A5568'
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: '#A0AEC0'
                                    },
                                    grid: {
                                        color: '#4A5568'
                                    }
                                }
                            }
                        }
                    });
                }
            })
            .catch(error => {
                console.error('获取科目对比数据失败:', error);
            });
        }

        // 导航函数
        function showClasses() {
            window.location.href = '/classes';
        }

        function showExams() {
            window.location.href = '/exams';
        }

        function showNotifications() {
            alert('消息通知功能');
        }

        function showSettings() {
            alert('系统设置功能');
        }

        function logout() {
            console.log('退出登录函数被调用');
            if(confirm('确定要退出登录吗？')) {
                console.log('用户确认退出登录');
                // 调用后端退出API清理Redis会话和Cookie
                fetch('/api/logout', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    console.log('退出API响应状态:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('退出API响应数据:', data);
                    if (data.success) {
                        console.log('退出登录成功:', data.message);
                        // 清除本地存储
                        localStorage.removeItem('currentUser');
                        // 跳转到主页
                        window.location.href = '/learning-platform';
                    } else {
                        console.error('退出登录失败:', data.message);
                        alert('退出登录失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('退出登录请求失败:', error);
                    // 即使API调用失败，也清除本地数据并跳转
                    localStorage.removeItem('currentUser');
                    window.location.href = '/learning-platform';
                });
            } else {
                console.log('用户取消退出登录');
            }
        }

        // 快捷操作函数
        function addExam() {
            alert('新建考试功能');
        }

        function addClass() {
            alert('添加班级功能');
        }

        function viewReports() {
            alert('查看报告功能');
        }

        function exportData() {
            alert('导出数据功能');
        }
    </script>
</body>
</html>