<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿æ¥è¯Šæ–­æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .result { margin: 10px 0; padding: 8px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        #results { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ğŸŒ è¿æ¥è¯Šæ–­æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>ğŸ”§ ç¯å¢ƒä¿¡æ¯</h2>
        <div id="envInfo"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ§ª è¿æ¥æµ‹è¯•</h2>
        <button onclick="testDirectConnection()">æµ‹è¯•ç›´æ¥è¿æ¥ (localhost:5000)</button>
        <button onclick="testRelativeConnection()">æµ‹è¯•ç›¸å¯¹è·¯å¾„è¿æ¥</button>
        <button onclick="testCurrentOrigin()">æµ‹è¯•å½“å‰åŸŸè¿æ¥</button>
        <button onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
    </div>

    <div class="test-section">
        <h2>ğŸ“‹ æµ‹è¯•ç»“æœ</h2>
        <div id="results"></div>
    </div>

    <script>
        // æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        function showEnvInfo() {
            const envDiv = document.getElementById('envInfo');
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            const port = window.location.port;
            const origin = window.location.origin;
            
            envDiv.innerHTML = `
                <div class="info">
                    <strong>å½“å‰é¡µé¢ä¿¡æ¯ï¼š</strong><br>
                    åè®®: ${protocol}<br>
                    ä¸»æœºå: ${hostname}<br>
                    ç«¯å£: ${port || 'é»˜è®¤ç«¯å£'}<br>
                    å®Œæ•´åœ°å€: ${origin}<br>
                    ç”¨æˆ·ä»£ç†: ${navigator.userAgent.substring(0, 100)}...
                </div>
            `;
        }

        // æ·»åŠ æµ‹è¯•ç»“æœ
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        // æ¸…ç©ºç»“æœ
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // æµ‹è¯•ç›´æ¥è¿æ¥åˆ°localhost:5000
        async function testDirectConnection() {
            addResult('å¼€å§‹æµ‹è¯•ç›´æ¥è¿æ¥åˆ° localhost:5000...', 'info');
            
            try {
                const response = await fetch('http://localhost:5000/api/subjects', {
                    method: 'GET',
                    mode: 'cors'
                });
                
                addResult(`çŠ¶æ€ç : ${response.status}`, 'info');
                addResult(`å†…å®¹ç±»å‹: ${response.headers.get('content-type')}`, 'info');
                
                if (response.ok) {
                    const data = await response.json();
                    addResult(`âœ… ç›´æ¥è¿æ¥æˆåŠŸï¼å­¦ç§‘æ•°é‡: ${data.subjects ? data.subjects.length : 0}`, 'success');
                    if (data.subjects && data.subjects.length > 0) {
                        addResult(`å­¦ç§‘åˆ—è¡¨: ${data.subjects.map(s => s.subject).join(', ')}`, 'info');
                    }
                } else {
                    addResult(`âŒ ç›´æ¥è¿æ¥å¤±è´¥: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                addResult(`âŒ ç›´æ¥è¿æ¥é”™è¯¯: ${error.message}`, 'error');
                // æä¾›å…·ä½“çš„é”™è¯¯å»ºè®®
                if (error.message.includes('Failed to fetch')) {
                    addResult('ğŸ’¡ å»ºè®®æ£€æŸ¥ï¼š<br>1. FlaskæœåŠ¡æ˜¯å¦åœ¨è¿è¡Œ<br>2. æ˜¯å¦å…è®¸è·¨åŸŸè¯·æ±‚<br>3. é˜²ç«å¢™è®¾ç½®', 'info');
                }
            }
        }

        // æµ‹è¯•ç›¸å¯¹è·¯å¾„è¿æ¥
        async function testRelativeConnection() {
            addResult('å¼€å§‹æµ‹è¯•ç›¸å¯¹è·¯å¾„è¿æ¥...', 'info');
            
            try {
                const response = await fetch('/api/subjects');
                addResult(`çŠ¶æ€ç : ${response.status}`, 'info');
                
                if (response.ok) {
                    const data = await response.json();
                    addResult(`âœ… ç›¸å¯¹è·¯å¾„è¿æ¥æˆåŠŸï¼å­¦ç§‘æ•°é‡: ${data.subjects ? data.subjects.length : 0}`, 'success');
                } else {
                    addResult(`âŒ ç›¸å¯¹è·¯å¾„è¿æ¥å¤±è´¥: ${response.status} ${response.statusText}`, 'error');
                    addResult(`å½“å‰é¡µé¢åŸŸå: ${window.location.origin}`, 'info');
                }
            } catch (error) {
                addResult(`âŒ ç›¸å¯¹è·¯å¾„è¿æ¥é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•å½“å‰åŸŸè¿æ¥
        async function testCurrentOrigin() {
            addResult('å¼€å§‹æµ‹è¯•å½“å‰åŸŸè¿æ¥...', 'info');
            
            try {
                const baseUrl = window.location.origin;
                const apiUrl = `${baseUrl}/api/subjects`;
                addResult(`è¯·æ±‚URL: ${apiUrl}`, 'info');
                
                const response = await fetch(apiUrl);
                addResult(`çŠ¶æ€ç : ${response.status}`, 'info');
                
                if (response.ok) {
                    const data = await response.json();
                    addResult(`âœ… å½“å‰åŸŸè¿æ¥æˆåŠŸï¼å­¦ç§‘æ•°é‡: ${data.subjects ? data.subjects.length : 0}`, 'success');
                } else {
                    addResult(`âŒ å½“å‰åŸŸè¿æ¥å¤±è´¥: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                addResult(`âŒ å½“å‰åŸŸè¿æ¥é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        document.addEventListener('DOMContentLoaded', function() {
            showEnvInfo();
        });
    </script>
</body>
</html>